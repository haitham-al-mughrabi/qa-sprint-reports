<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Data - Sprint Reports System</title>
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="preload"
        as="style" onload="this.rel='stylesheet'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Main styles -->
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/unified-nav.css">
    <link rel="stylesheet" href="/static/rtl-support.css">
    <link rel="stylesheet" href="/static/manage_data.css">

    <!-- Theme manager (loads early) -->
    <script src="/static/theme-manager.js"></script>

    <!-- Load non-critical CSS asynchronously -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
        media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    </noscript>
</head>

<body>
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-brand"><i class="fas fa-rocket"></i> Sprint Reports System</div>
            <div style="display: flex; align-items: center;">
                <div class="nav-links">
                    <a href="/dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> <span
                            data-i18n="nav_dashboard">Dashboard</span></a>
                    <a href="/reports" class="nav-link"><i class="fas fa-chart-line"></i> <span
                            data-i18n="nav_reports">Reports</span></a>
                    <a href="/create-report" class="nav-link"><i class="fas fa-plus-circle"></i> <span
                            data-i18n="nav_new_report">New Report</span></a>
                    <a href="/manage" class="nav-link active"><i class="fas fa-cogs"></i> <span
                            data-i18n="nav_manage_data">Manage Data</span></a>
                    <a href="/project-statistics" class="nav-link"><i class="fas fa-chart-pie"></i> <span
                            data-i18n="nav_project_statistics">Project Statistics</span></a>
                </div>
                <div class="nav-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-sun" id="theme-icon"></i>
                        <span id="theme-text" data-i18n="theme_light">Light</span>
                    </button>
                    <button class="lang-toggle" id="language-toggle" onclick="toggleLanguage()"
                        data-i18n="language">العربية</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <div class="header-content">
                <h1 data-i18n="manage_system_data">Manage System Data</h1>
                <p data-i18n="administer_data">Administer portfolios, projects, testers, and team members</p>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs">
                <button class="btn btn-secondary active" onclick="showTab('portfolios')"><i
                        class="fas fa-briefcase"></i> <span data-i18n="portfolios">Portfolios</span></button>
                <button class="btn btn-secondary" onclick="showTab('projects')"><i class="fas fa-project-diagram"></i>
                    <span data-i18n="projects">Projects</span></button>
                <button class="btn btn-secondary" onclick="showTab('testers')"><i class="fas fa-user-cog"></i> <span
                        data-i18n="testers">Testers</span></button>
                <button class="btn btn-secondary" onclick="showTab('team')"><i class="fas fa-users"></i> <span
                        data-i18n="team">Team</span></button>
            </div>
        </div>

        <!-- Portfolio Management -->
        <div id="portfolios" class="tab-content active">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-briefcase"></i> <span
                            data-i18n="portfolio_management">Portfolio Management</span></h2>
                    <button class="btn btn-primary" onclick="showAddPortfolioModal()"><i class="fas fa-plus-circle"></i>
                        <span data-i18n="add_portfolio">Add Portfolio</span></button>
                </div>
                <div class="search-filter-container">
                    <input type="text" data-i18n-placeholder="search_portfolios" placeholder="Search portfolios..."
                        id="portfolioSearch" onkeyup="displayPortfolios()">
                </div>
                <div class="stats-grid">
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-briefcase"></i></div>
                        <h3 id="totalPortfolios">0</h3>
                        <p data-i18n="total_portfolios">Total Portfolios</p>
                    </div>
                </div>
                <div id="portfoliosList" class="data-list"></div>
            </div>
        </div>

        <!-- Project Management -->
        <div id="projects" class="tab-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-project-diagram"></i> <span data-i18n="projects">Project
                            Management</span></h2>
                    <button class="btn btn-primary" onclick="showAddProjectModal()"><i class="fas fa-plus-circle"></i>
                        <span data-i18n="add">Add Project</span></button>
                </div>
                <div class="search-filter-container">
                    <input type="text" data-i18n-placeholder="search_projects" placeholder="Search projects..."
                        id="projectSearch" onkeyup="displayProjects()">
                    <select class="filter-select" id="portfolioFilter" onchange="displayProjects()">
                        <option value="" data-i18n="all_portfolios">All Portfolios</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-project-diagram"></i></div>
                        <h3 id="totalProjects">0</h3>
                        <p data-i18n="total_projects">Total Projects</p>
                    </div>
                </div>
                <div id="projectsList" class="data-list">
                    <div class="empty-state">Loading projects...</div>
                </div>
            </div>
        </div>

        <!-- Tester Management -->
        <div id="testers" class="tab-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-user-cog"></i> <span data-i18n="testers">Tester
                            Management</span></h2>
                    <button class="btn btn-primary" onclick="showAddTesterModal()"><i class="fas fa-plus-circle"></i>
                        <span data-i18n="add">Add Tester</span></button>
                </div>
                <div class="search-filter-container">
                    <input type="text" data-i18n-placeholder="search_testers" placeholder="Search testers..."
                        id="testerSearch" onkeyup="displayTesters()">
                </div>
                <div class="stats-grid">
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-user-cog"></i></div>
                        <h3 id="totalTesters">0</h3>
                        <p data-i18n="total_testers">Total Testers</p>
                    </div>
                </div>
                <div id="testersList" class="data-list">
                    <div class="empty-state">Loading testers...</div>
                </div>
            </div>
        </div>

        <!-- Team Member Management -->
        <div id="team" class="tab-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-users"></i> <span data-i18n="team">Team Member
                            Management</span></h2>
                    <button class="btn btn-primary" onclick="showAddTeamMemberModal()"><i
                            class="fas fa-plus-circle"></i> <span data-i18n="add_team_member">Add Team
                            Member</span></button>
                </div>
                <div class="search-filter-container">
                    <input type="text" data-i18n-placeholder="search_team_members" placeholder="Search team members..."
                        id="teamSearch" onkeyup="displayTeamMembers()">
                    <select class="filter-select" id="roleFilter" onchange="displayTeamMembers()">
                        <option value="" data-i18n="all_roles">All Roles</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-users"></i></div>
                        <h3 id="totalTeamMembers">0</h3>
                        <p data-i18n="total_team">Total Team</p>
                    </div>
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-crown"></i></div>
                        <h3 id="projectOwners">0</h3>
                        <p data-i18n="project_owners">Project Owners</p>
                    </div>
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-user-graduate"></i></div>
                        <h3 id="projectAnalysts">0</h3>
                        <p data-i18n="analysts">Analysts</p>
                    </div>
                    <div class="stat-card-small">
                        <div class="icon-bg"><i class="fas fa-user-tie"></i></div>
                        <h3 id="projectManagers">0</h3>
                        <p data-i18n="managers">Managers</p>
                    </div>
                </div>
                <div id="teamMembersList" class="data-list">
                    <div class="empty-state">Loading team members...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addPortfolioModal" class="modal manage-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="icon-bg"><i class="fas fa-briefcase"></i></div>
                <h3 data-i18n="add_new_portfolio">Add New Portfolio</h3>
            </div>
            <div class="modal-form">
                <div class="form-group"><label for="portfolioName" data-i18n="portfolio_name">Portfolio
                        Name:</label><input type="text" id="portfolioName" required></div>
                <div class="form-group"><label for="portfolioDescription"
                        data-i18n="description">Description:</label><textarea id="portfolioDescription"
                        rows="4"></textarea></div>
            </div>
            <div class="modal-buttons"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('addPortfolioModal')" data-i18n="cancel">Cancel</button><button type="button"
                    class="btn btn-primary" onclick="savePortfolio()" data-i18n="save">Save</button></div>
        </div>
    </div>

    <div id="addProjectModal" class="modal manage-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="icon-bg"><i class="fas fa-project-diagram"></i></div>
                <h3 data-i18n="add_new_project">Add New Project</h3>
            </div>
            <div class="modal-form">
                <div class="form-group"><label for="projectName" data-i18n="project_name">Project Name:</label><input
                        type="text" id="projectName" required></div>
                <div class="form-group"><label for="projectPortfolio" data-i18n="portfolio">Portfolio:</label><select
                        id="projectPortfolio">
                        <option value="" data-i18n="no_portfolio">No Portfolio (Standalone Project)</option>
                    </select></div>
                <div class="form-group"><label for="projectDescription"
                        data-i18n="description">Description:</label><textarea id="projectDescription"
                        rows="4"></textarea></div>
            </div>
            <div class="modal-buttons"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('addProjectModal')" data-i18n="cancel">Cancel</button><button type="button"
                    class="btn btn-primary" onclick="saveProject()" data-i18n="save">Save</button></div>
        </div>
    </div>

    <div id="addTesterModal" class="modal manage-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="icon-bg"><i class="fas fa-user-cog"></i></div>
                <h3 data-i18n="add_new_tester">Add New Tester</h3>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="testerName" data-i18n="name">Name:</label>
                        <input type="text" id="testerName" required>
                    </div>
                    <div class="form-group">
                        <label for="testerEmail" data-i18n="email">Email:</label>
                        <input type="email" id="testerEmail" required>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="tester_roles">Tester Roles:</label>
                    <div class="checkbox-list" style="max-height: 200px; padding: 1rem; overflow-y: auto;">
                        <label class="checkbox-item">
                            <input type="checkbox" id="isAutomationEngineer">
                            <span class="checkbox-text">
                                <strong>Automation Engineer</strong>
                                <small>Handles automated testing tasks</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isManualEngineer">
                            <span class="checkbox-text">
                                <strong>Manual Engineer</strong>
                                <small>Handles manual testing tasks</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isPerformanceTester">
                            <span class="checkbox-text">
                                <strong>Performance Tester</strong>
                                <small>Specializes in performance and load testing</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isSecurityTester">
                            <span class="checkbox-text">
                                <strong>Security Tester</strong>
                                <small>Focuses on security and vulnerability testing</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isApiTester">
                            <span class="checkbox-text">
                                <strong>API Tester</strong>
                                <small>Specializes in API and backend testing</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isMobileTester">
                            <span class="checkbox-text">
                                <strong>Mobile Tester</strong>
                                <small>Focuses on mobile application testing</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isWebTester">
                            <span class="checkbox-text">
                                <strong>Web Tester</strong>
                                <small>Specializes in web application testing</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isAccessibilityTester">
                            <span class="checkbox-text">
                                <strong>Accessibility Tester</strong>
                                <small>Ensures accessibility compliance (WCAG, ADA)</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isUsabilityTester">
                            <span class="checkbox-text">
                                <strong>Usability Tester</strong>
                                <small>Focuses on user experience and usability</small>
                            </span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="isTestLead">
                            <span class="checkbox-text">
                                <strong>Test Lead</strong>
                                <small>Leads testing teams and coordinates testing activities</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="assign_projects">Assign to Projects (Optional):</label>
                    <div id="projectAssignmentList" class="checkbox-list" style="max-height: 150px; padding: 1rem; overflow-y: auto;">
                        <!-- Project checkboxes will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-buttons"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('addTesterModal')" data-i18n="cancel">Cancel</button><button type="button"
                    class="btn btn-primary" onclick="saveTester()" data-i18n="save">Save</button></div>
        </div>
    </div>

    <div id="addTeamMemberModal" class="modal manage-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="icon-bg"><i class="fas fa-users"></i></div>
                <h3 data-i18n="add_new_team_member">Add New Team Member</h3>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <div class="form-group"><label for="teamMemberName" data-i18n="name">Name:</label><input type="text"
                            id="teamMemberName" required></div>
                    <div class="form-group"><label for="teamMemberEmail" data-i18n="email">Email:</label><input
                            type="email" id="teamMemberEmail" required></div>
                </div>
                <div class="form-group"><label for="teamMemberRole" data-i18n="role">Role:</label><select
                        id="teamMemberRole" required>
                        <option value="" data-i18n="select_role">Select Role</option>
                    </select></div>
            </div>
            <div class="modal-buttons"><button type="button" class="btn btn-secondary"
                    onclick="closeModal('addTeamMemberModal')" data-i18n="cancel">Cancel</button><button type="button"
                    class="btn btn-primary" onclick="saveTeamMember()" data-i18n="save">Save</button></div>
        </div>
    </div>

    <!-- Assign Tester to Projects Modal -->
    <div id="assignTesterProjectsModal" class="modal manage-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="icon-bg"><i class="fas fa-link"></i></div>
                <h3 data-i18n="assign_tester_projects">Assign Tester to Projects</h3>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label id="selectedTesterName">Selected Tester:</label>
                    <p id="selectedTesterInfo" style="margin: 0; font-weight: bold; color: var(--primary);"></p>
                </div>
                <div class="form-group">
                    <label data-i18n="select_projects">Select Projects:</label>
                    <div id="projectCheckboxList" class="checkbox-list">
                        <!-- Project checkboxes will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeModal('assignTesterProjectsModal')"
                    data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTesterProjects()"
                    data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Link to the external JavaScript files -->
    <script src="/static/translations.js" defer></script>
    <script src="/static/language-manager.js" defer></script>
    <script src="/static/enhanced_script.js" defer></script>
    <script>
        let portfolios = [];
        let projects = [];
        let testers = [];
        let teamMembers = [];
        let editingId = null;

        const roles = ["Project Owner", "Project Analyst", "Project Manager", "Business Analyst", "Technical Lead", "Scrum Master", "Product Owner", "Quality Assurance Lead", "DevOps Engineer", "UI/UX Designer", "Database Administrator", "Security Analyst", "System Administrator", "Stakeholder", "Client Representative"];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupRoleFilters();
            await loadAllData();
            updateAll();

        });

        function setupRoleFilters() {
            const roleFilter = document.getElementById('roleFilter');
            const teamMemberRole = document.getElementById('teamMemberRole');
            roles.forEach(role => {
                roleFilter.innerHTML += `<option value="${role}">${role}</option>`;
                teamMemberRole.innerHTML += `<option value="${role}">${role}</option>`;
            });
        }

        async function loadAllData() {
            try {
                [portfolios, projects, testers, teamMembers] = await Promise.all([
                    fetch('/api/portfolios').then(res => res.ok ? res.json() : []),
                    fetch('/api/projects').then(res => res.ok ? res.json() : []),
                    fetch('/api/testers').then(res => res.ok ? res.json() : []),
                    fetch('/api/team-members').then(res => res.ok ? res.json() : [])
                ]);
            } catch (error) {
                console.error("Failed to load data:", error);
            }
        }

        function updateAll() {
            updateStats();
            displayAllLists();
            populatePortfolioFilter();
            populatePortfolioDropdown();
        }

        function updateStats() {
            document.getElementById('totalPortfolios').textContent = portfolios.length;
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalTesters').textContent = testers.length;
            document.getElementById('totalTeamMembers').textContent = teamMembers.length;
            document.getElementById('projectOwners').textContent = teamMembers.filter(tm => tm.role === 'Project Owner').length;
            document.getElementById('projectAnalysts').textContent = teamMembers.filter(tm => tm.role === 'Project Analyst').length;
            document.getElementById('projectManagers').textContent = teamMembers.filter(tm => tm.role === 'Project Manager').length;
        }

        // --- DISPLAY & RENDER FUNCTIONS ---
        function displayAllLists() {
            displayPortfolios();
            displayProjects();
            displayTesters();
            displayTeamMembers();
        }

        function renderList(type, data, renderer, emptyIcon, emptyTitle, emptyText) {
            const container = document.getElementById(`${type}List`);
            if (data.length === 0) {
                container.innerHTML = `<div class="empty-data-state">
                    <div class="icon-bg"><i class="fas ${emptyIcon}"></i></div>
                    <h3>${emptyTitle}</h3>
                    <p>${emptyText}</p>
                </div>`;
                return;
            }
            container.innerHTML = data.map(renderer).join('');
        }

        // Portfolios
        function displayPortfolios() {
            const searchTerm = document.getElementById('portfolioSearch')?.value.toLowerCase() || '';
            const filtered = portfolios.filter(p => p.name.toLowerCase().includes(searchTerm));
            renderList('portfolios', filtered, renderPortfolio, 'fa-folder-open', 'No Portfolios Found', 'Add a portfolio to get started.');
        }
        const renderPortfolio = p => `<div class="data-item"><div class="data-item-header"><h3 class="data-item-title">${p.name}</h3><div class="data-item-actions"><button class="btn-edit" onclick="editPortfolio(${p.id})"><i class="fas fa-edit"></i></button><button class="btn-delete" onclick="deleteItem('portfolios', ${p.id})"><i class="fas fa-trash"></i></button></div></div><div class="data-item-content"><p>${p.description || 'No description'}</p><p><strong>Projects:</strong> ${projects.filter(proj => proj.portfolio_id === p.id).length}</p></div></div>`;

        // Projects
        function displayProjects() {
            const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
            const portfolioId = document.getElementById('portfolioFilter')?.value;
            let filtered = projects;
            if (portfolioId) {
                filtered = filtered.filter(p => p.portfolio_id == portfolioId);
            }
            if (searchTerm) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
            }
            renderList('projects', filtered, renderProject, 'fa-rocket', 'No Projects Found', 'Add a project to get started.');
        }
        const renderProject = p => `<div class="data-item"><div class="data-item-header"><h3 class="data-item-title">${p.name}</h3><div class="data-item-actions"><button class="btn-edit" onclick="editProject(${p.id})"><i class="fas fa-edit"></i></button><button class="btn-delete" onclick="deleteItem('projects', ${p.id})"><i class="fas fa-trash"></i></button></div></div><div class="data-item-content"><p><strong>Portfolio:</strong> ${portfolios.find(pf => pf.id === p.portfolio_id)?.name || 'No Portfolio'}</p><p>${p.description || 'No description'}</p></div></div>`;

        // Testers
        function displayTesters() {
            const searchTerm = document.getElementById('testerSearch')?.value.toLowerCase() || '';
            const filtered = testers.filter(t => t.name.toLowerCase().includes(searchTerm) || t.email.toLowerCase().includes(searchTerm));
            renderList('testers', filtered, renderTester, 'fa-vial', 'No Testers Found', 'Add a tester to the system.');
        }
        const renderTester = t => {
            const roleBadges = [];
            if (t.is_automation_engineer) roleBadges.push('<span class="role-badge">Automation Engineer</span>');
            if (t.is_manual_engineer) roleBadges.push('<span class="role-badge">Manual Engineer</span>');
            if (t.is_performance_tester) roleBadges.push('<span class="role-badge">Performance Tester</span>');
            if (t.is_security_tester) roleBadges.push('<span class="role-badge">Security Tester</span>');
            if (t.is_api_tester) roleBadges.push('<span class="role-badge">API Tester</span>');
            if (t.is_mobile_tester) roleBadges.push('<span class="role-badge">Mobile Tester</span>');
            if (t.is_web_tester) roleBadges.push('<span class="role-badge">Web Tester</span>');
            if (t.is_accessibility_tester) roleBadges.push('<span class="role-badge">Accessibility Tester</span>');
            if (t.is_usability_tester) roleBadges.push('<span class="role-badge">Usability Tester</span>');
            if (t.is_test_lead) roleBadges.push('<span class="role-badge test-lead">Test Lead</span>');
            
            const roleDisplay = roleBadges.length > 0 ? roleBadges.join(' ') : '<span style="color: var(--text-secondary); font-style: italic;">No roles assigned</span>';
            
            // Show assigned projects count
            const projectCount = t.project_ids ? t.project_ids.length : 0;
            const projectText = projectCount === 1 ? '1 project' : `${projectCount} projects`;

            return `<div class="data-item">
                <div class="data-item-header">
                    <h3 class="data-item-title">${t.name}</h3>
                    <div class="data-item-actions">
                        <button class="btn-secondary" onclick="showAssignTesterProjectsModal(${t.id})" title="Assign Projects"><i class="fas fa-link"></i></button>
                        <button class="btn-edit" onclick="editTester(${t.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="deleteItem('testers', ${t.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="data-item-content">
                    <p><strong>Email:</strong> ${t.email}</p>
                    <p><strong>Roles:</strong> ${roleDisplay}</p>
                    <p><strong>Assigned to:</strong> ${projectText}</p>
                </div>
            </div>`;
        };

        // Team Members
        function displayTeamMembers() {
            const searchTerm = document.getElementById('teamSearch')?.value.toLowerCase() || '';
            const role = document.getElementById('roleFilter')?.value;
            let filtered = teamMembers;
            if (role) {
                filtered = filtered.filter(m => m.role === role);
            }
            if (searchTerm) {
                filtered = filtered.filter(m => m.name.toLowerCase().includes(searchTerm) || m.email.toLowerCase().includes(searchTerm));
            }
            renderList('teamMembers', filtered, renderTeamMember, 'fa-users', 'No Team Members Found', 'Add a team member to the system.');
        }
        const renderTeamMember = m => `<div class="data-item"><div class="data-item-header"><h3 class="data-item-title">${m.name}</h3><div class="data-item-actions"><button class="btn-edit" onclick="editTeamMember(${m.id})"><i class="fas fa-edit"></i></button><button class="btn-delete" onclick="deleteItem('team-members', ${m.id})"><i class="fas fa-trash"></i></button></div></div><div class="data-item-content"><p><strong>Email:</strong> ${m.email}</p><span class="role-badge">${m.role}</span></div></div>`;

        // --- TABS & MODALS ---
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tabs .btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show target content
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.style.display = 'block';
                targetContent.classList.add('active');
            }

            // Add active class to clicked button
            const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Call the appropriate display function to populate the tab content
            switch (tabName) {
                case 'portfolios':
                    displayPortfolios();
                    break;
                case 'projects':
                    displayProjects();
                    break;
                case 'testers':
                    displayTesters();
                    break;
                case 'team':
                    displayTeamMembers();
                    break;
            }
        }

        function showModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        // Simple toast notification function
        function showToast(message, type = 'info') {
            // Create toast element if it doesn't exist
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    padding: 12px 20px; border-radius: 5px; color: white;
                    font-weight: bold; opacity: 0; transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
            }

            // Set background color based on type
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            toast.style.backgroundColor = colors[type] || colors.info;

            // Show toast
            toast.textContent = message;
            toast.style.opacity = '1';

            // Hide after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        function populatePortfolioDropdown(selectedId = '') {
            const select = document.getElementById('projectPortfolio');
            if (!select) return;

            select.innerHTML = '<option value="">No Portfolio (Standalone Project)</option>';

            if (portfolios && Array.isArray(portfolios)) {
                portfolios.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    if (p.id == selectedId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        }
        function populatePortfolioFilter() {
            const select = document.getElementById('portfolioFilter');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">All Portfolios</option>';

            if (portfolios && Array.isArray(portfolios)) {
                select.innerHTML += portfolios.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }

            select.value = currentValue;
        }
        
        function populateProjectAssignmentList(selectedProjectIds = []) {
            const container = document.getElementById('projectAssignmentList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (projects && Array.isArray(projects) && projects.length > 0) {
                projects.forEach(project => {
                    const portfolioName = project.portfolio_name || 'No Portfolio';
                    const isChecked = selectedProjectIds.includes(project.id);
                    
                    const checkboxItem = document.createElement('label');
                    checkboxItem.className = 'checkbox-item';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" id="project_${project.id}" value="${project.id}" ${isChecked ? 'checked' : ''}>
                        <span class="checkbox-text">
                            <strong>${project.name}</strong>
                            <small>${portfolioName}</small>
                        </span>
                    `;
                    container.appendChild(checkboxItem);
                });
            } else {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No projects available</p>';
            }
        }

        // --- CRUD OPERATIONS ---
        // Show Modals for Adding
        function showAddPortfolioModal() { editingId = null; document.getElementById('portfolioName').value = ''; document.getElementById('portfolioDescription').value = ''; showModal('addPortfolioModal'); }
        async function showAddProjectModal() {
            editingId = null;
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';

            // Ensure data is loaded before populating dropdown
            if (!portfolios || portfolios.length === 0) {
                await loadAllData();
            }

            populatePortfolioDropdown();
            showModal('addProjectModal');
        }
        async function showAddTesterModal() {
            editingId = null;
            document.getElementById('testerName').value = '';
            document.getElementById('testerEmail').value = '';
            
            // Reset all role checkboxes
            document.getElementById('isAutomationEngineer').checked = false;
            document.getElementById('isManualEngineer').checked = false;
            document.getElementById('isPerformanceTester').checked = false;
            document.getElementById('isSecurityTester').checked = false;
            document.getElementById('isApiTester').checked = false;
            document.getElementById('isMobileTester').checked = false;
            document.getElementById('isWebTester').checked = false;
            document.getElementById('isAccessibilityTester').checked = false;
            document.getElementById('isUsabilityTester').checked = false;
            document.getElementById('isTestLead').checked = false;
            
            // Ensure projects are loaded before populating project list
            if (!projects || projects.length === 0) {
                await loadAllData();
            }
            
            populateProjectAssignmentList();
            showModal('addTesterModal');
        }
        function showAddTeamMemberModal() { editingId = null; document.getElementById('teamMemberName').value = ''; document.getElementById('teamMemberEmail').value = ''; document.getElementById('teamMemberRole').value = ''; showModal('addTeamMemberModal'); }

        // Show Modals for Editing
        function editPortfolio(id) { const p = portfolios.find(i => i.id === id); if (!p) return; editingId = id; document.getElementById('portfolioName').value = p.name; document.getElementById('portfolioDescription').value = p.description; showModal('addPortfolioModal'); }
        function editProject(id) { const p = projects.find(i => i.id === id); if (!p) return; editingId = id; document.getElementById('projectName').value = p.name; document.getElementById('projectDescription').value = p.description; populatePortfolioDropdown(p.portfolio_id); showModal('addProjectModal'); }
        async function editTester(id) {
            const t = testers.find(i => i.id === id);
            if (!t) return;
            
            editingId = id;
            document.getElementById('testerName').value = t.name;
            document.getElementById('testerEmail').value = t.email;
            
            // Set all role checkboxes
            document.getElementById('isAutomationEngineer').checked = t.is_automation_engineer || false;
            document.getElementById('isManualEngineer').checked = t.is_manual_engineer || false;
            document.getElementById('isPerformanceTester').checked = t.is_performance_tester || false;
            document.getElementById('isSecurityTester').checked = t.is_security_tester || false;
            document.getElementById('isApiTester').checked = t.is_api_tester || false;
            document.getElementById('isMobileTester').checked = t.is_mobile_tester || false;
            document.getElementById('isWebTester').checked = t.is_web_tester || false;
            document.getElementById('isAccessibilityTester').checked = t.is_accessibility_tester || false;
            document.getElementById('isUsabilityTester').checked = t.is_usability_tester || false;
            document.getElementById('isTestLead').checked = t.is_test_lead || false;
            
            // Ensure projects are loaded before populating project list
            if (!projects || projects.length === 0) {
                await loadAllData();
            }
            
            // Populate project assignment list with current assignments
            populateProjectAssignmentList(t.project_ids || []);
            
            showModal('addTesterModal');
        }
        function editTeamMember(id) { const m = teamMembers.find(i => i.id === id); if (!m) return; editingId = id; document.getElementById('teamMemberName').value = m.name; document.getElementById('teamMemberEmail').value = m.email; document.getElementById('teamMemberRole').value = m.role; showModal('addTeamMemberModal'); }

        // Save Data (Create/Update)
        async function saveData(type, body, modalId) {
            const url = editingId ? `/api/${type}/${editingId}` : `/api/${type}`;
            const method = editingId ? 'PUT' : 'POST';
            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (response.ok) {
                    await loadAllData();
                    updateAll();
                    closeModal(modalId);
                    showToast(`${type.slice(0, -1)} ${editingId ? 'updated' : 'created'} successfully!`, 'success');
                    return true; // Success
                } else {
                    const errorData = await response.json();
                    alert(`Failed to save ${type}: ${errorData.error || 'Unknown error'}`);
                    return false; // Failure
                }
            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                alert(`An error occurred while saving ${type}.`);
                return false; // Failure
            } finally {
                editingId = null;
            }
        }

        async function savePortfolio() {
            const name = document.getElementById('portfolioName').value.trim();
            const description = document.getElementById('portfolioDescription').value.trim();

            if (!name) {
                alert('Portfolio name is required');
                return;
            }

            const result = await saveData('portfolios', { name, description }, 'addPortfolioModal');
            if (result && !editingId) {
                // If it's a new portfolio (not editing), offer to add a project
                setTimeout(() => {
                    if (confirm('Would you like to add a project to the new portfolio?')) {
                        // Ensure data is loaded before opening modal
                        loadAllData().then(() => {
                            showAddProjectModal();
                        });
                    }
                }, 500);
            }
        }
        async function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            const portfolio_id = document.getElementById('projectPortfolio').value || null;
            const description = document.getElementById('projectDescription').value.trim();

            if (!name) {
                alert('Project name is required');
                return;
            }

            await saveData('projects', { name, portfolio_id, description }, 'addProjectModal');
        }
        async function saveTester() {
            const name = document.getElementById('testerName').value.trim();
            const email = document.getElementById('testerEmail').value.trim();
            
            if (!name || !email) {
                alert('Name and email are required');
                return;
            }
            
            // Get all role checkboxes
            const testerData = {
                name,
                email,
                is_automation_engineer: document.getElementById('isAutomationEngineer').checked,
                is_manual_engineer: document.getElementById('isManualEngineer').checked,
                is_performance_tester: document.getElementById('isPerformanceTester').checked,
                is_security_tester: document.getElementById('isSecurityTester').checked,
                is_api_tester: document.getElementById('isApiTester').checked,
                is_mobile_tester: document.getElementById('isMobileTester').checked,
                is_web_tester: document.getElementById('isWebTester').checked,
                is_accessibility_tester: document.getElementById('isAccessibilityTester').checked,
                is_usability_tester: document.getElementById('isUsabilityTester').checked,
                is_test_lead: document.getElementById('isTestLead').checked
            };
            
            // Get selected project IDs
            const projectCheckboxes = document.querySelectorAll('#projectAssignmentList input[type="checkbox"]:checked');
            const selectedProjectIds = Array.from(projectCheckboxes).map(cb => parseInt(cb.value));
            testerData.project_ids = selectedProjectIds;
            
            await saveData('testers', testerData, 'addTesterModal');
        }
        function saveTeamMember() { const name = document.getElementById('teamMemberName').value, email = document.getElementById('teamMemberEmail').value, role = document.getElementById('teamMemberRole').value; if (name && email && role) saveData('team-members', { name, email, role }, 'addTeamMemberModal'); }

        // Tester-Project Assignment Functions
        let currentTesterId = null;

        function showAssignTesterProjectsModal(testerId) {
            currentTesterId = testerId;
            const tester = testers.find(t => t.id === testerId);
            if (!tester) return;

            // Update tester info
            document.getElementById('selectedTesterInfo').textContent = `${tester.name} (${tester.email})`;

            // Populate project checkboxes
            populateProjectCheckboxes(testerId);

            showModal('assignTesterProjectsModal');
        }

        async function populateProjectCheckboxes(testerId) {
            const container = document.getElementById('projectCheckboxList');

            // Get tester's current projects
            let testerProjects = [];
            try {
                const response = await fetch(`/api/testers/${testerId}/projects`);
                if (response.ok) {
                    testerProjects = await response.json();
                }
            } catch (error) {
                console.error('Error loading tester projects:', error);
            }

            const testerProjectIds = testerProjects.map(p => p.id);

            // Create checkboxes for all projects
            container.innerHTML = projects.map(project => {
                const portfolioName = project.portfolio_name || 'No Portfolio';
                const isChecked = testerProjectIds.includes(project.id) ? 'checked' : '';
                return `
                    <label class="checkbox-item">
                        <input type="checkbox" value="${project.id}" ${isChecked}>
                        <span class="checkbox-text">
                            <strong>${project.name}</strong>
                            <small>(${portfolioName})</small>
                        </span>
                    </label>
                `;
            }).join('');
        }

        async function saveTesterProjects() {
            if (!currentTesterId) return;

            const checkboxes = document.querySelectorAll('#projectCheckboxList input[type="checkbox"]:checked');
            const projectIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            try {
                const response = await fetch(`/api/testers/${currentTesterId}/projects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_ids: projectIds })
                });

                if (response.ok) {
                    closeModal('assignTesterProjectsModal');
                    showToast('Tester projects updated successfully!', 'success');
                    updateAll(); // Refresh the displays
                } else {
                    showToast('Failed to update tester projects.', 'error');
                }
            } catch (error) {
                console.error('Error saving tester projects:', error);
                showToast('An error occurred while updating tester projects.', 'error');
            }
        }

        // Delete Data
        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                const response = await fetch(`/api/${type}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await loadAllData();
                    updateAll();
                }
                else { alert(`Failed to delete ${type}.`); }
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                alert(`An error occurred while deleting ${type}.`);
            }
        }

        // Theme functions are now handled by theme-manager.js

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme first
            if (window.themeManager) {
                window.themeManager.init();
            }

            // Set active class for navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === window.location.pathname) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
    </script>
    </div>

</body>

</html>