<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Report View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/static/view_report.css">
    <link rel="stylesheet" href="/static/unified-nav.css">
    <link rel="stylesheet" href="/static/rtl-support.css">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-brand"><i class="fas fa-rocket"></i> Sprint Reports System</div>
            <div style="display: flex; align-items: center;">
                <div class="nav-links">
                    <a href="/dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="/reports" class="nav-link active"><i class="fas fa-chart-line"></i> Reports</a>
                    <a href="/create-report" class="nav-link"><i class="fas fa-plus-circle"></i> New Report</a>
                    <a href="/manage" class="nav-link"><i class="fas fa-cogs"></i> Manage Data</a>
                    <a href="/project-statistics" class="nav-link"><i class="fas fa-chart-pie"></i> Project Statistics</a>
                </div>
                <div class="nav-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-sun" id="theme-icon"></i>
                        <span id="theme-text" data-i18n="theme_light">Light</span>
                    </button>
                    <button class="lang-toggle" id="language-toggle" onclick="toggleLanguage()" data-i18n="language">العربية</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="dashboard-container">
            <div class="page-header">
                <div class="header-content">
                    <h1 id="reportTitle">Sprint Testing Report</h1>
                    <p id="reportSubtitle">Loading report details...</p>
                </div>
                <div class="header-actions">
                    <div class="action-group">
                        <button class="action-btn btn-back" onclick="window.location.href='/reports'">
                            <i class="fas fa-arrow-left"></i> Back to Reports
                        </button>
                        <button class="action-btn btn-edit" onclick="editCurrentReport()" id="editReportBtn">
                            <i class="fas fa-edit"></i> Edit Report
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteCurrentReport()" id="deleteReportBtn">
                            <i class="fas fa-trash-alt"></i> Delete Report
                        </button>
                    </div>
                    <div class="export-group">
                        <button class="action-btn btn-export-pdf" onclick="exportCurrentReportAsPdf()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="action-btn btn-export-excel" onclick="exportCurrentReportAsExcel()">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button class="action-btn btn-export-styled-pdf" onclick="exportStyledReportAsPdf()">
                            <i class="fas fa-file-pdf"></i> Styled PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingSection" class="empty-state loading">
            <div class="spinner"></div>
            <h3>Loading Report Data...</h3>
            <p>Please wait while we fetch your report.</p>
        </div>

        <div class="dashboard-container" id="reportContent" style="display: none;">
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-info-circle"></i> General Information</h2>
                <div class="info-grid" id="coverInfo">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Test Summary & Status</h2>
                <div class="info-grid" id="testSummaryContent">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Testing Metrics Overview</h2>
                <div class="info-grid" id="metricsOverview">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-user-check"></i> User Stories Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">User Stories Summary</h3>
                        <table class="data-table" id="userStoriesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">User Stories Distribution</h3>
                        <div class="chart-container">
                            <canvas id="userStoriesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-flask"></i> Test Cases Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Cases Summary</h3>
                        <table class="data-table" id="testCasesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Cases Distribution</h3>
                        <div class="chart-container">
                            <canvas id="testCasesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> Issues by Priority</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Priority Breakdown</h3>
                        <table class="data-table" id="issuesPriorityViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Priority Chart</h3>
                        <div class="chart-container">
                            <canvas id="issuesPriorityViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-tasks"></i> Issues by Status</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Status Breakdown</h3>
                        <table class="data-table" id="issuesStatusViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Status Chart</h3>
                        <div class="chart-container">
                            <canvas id="issuesStatusViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-magic"></i> Enhancements Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Enhancements Summary</h3>
                        <table class="data-table" id="enhancementsViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Enhancements Distribution</h3>
                        <div class="chart-container">
                            <canvas id="enhancementsViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section" id="additionalInfoSection">
                <h2 class="section-title"><i class="fas fa-info"></i> Additional Information</h2>
                </div>

            <div class="dashboard-section" id="qaNotesSection">
                <h2 class="section-title"><i class="fas fa-sticky-note"></i> <span data-i18n="qa_notes">QA Notes</span></h2>
                <div class="info-item">
                    <div class="info-label" data-i18n="additional_notes">Additional Notes</div>
                    <div class="info-value" id="qaNotesContent">
                        <!-- QA Notes content will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/theme-manager.js"></script>
    <script src="/static/translations.js"></script>
    <script src="/static/language-manager.js"></script>
    <script src="/static/translations-helper.js"></script>
    <script>
        let currentReport = null;
        let viewCharts = {};

        // Toast notification functions
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
                <div class="toast-message">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto-hide toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function showSuccessToast(message) {
            showToast(message, 'success');
        }

        function showErrorToast(message) {
            showToast(message, 'error');
        }

        function showWarningToast(message) {
            showToast(message, 'warning');
        }

        function showInfoToast(message) {
            showToast(message, 'info');
        }

        // Get report ID from URL
        const reportId = window.location.pathname.split('/').pop();
        console.log('Attempting to load report ID:', reportId); // Log the ID being used

        // Load report data when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize theme first
            if (window.themeManager) {
                window.themeManager.init();
            }
            await loadReportData(reportId);
        });

        async function loadReportData(id) {
            try {
                // Ensure the URL is correctly formed and accessible
                const apiUrl = `/api/reports/${id}`;
                console.log('Fetching report from:', apiUrl); // Log the full API URL

                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    // Log detailed error information from the server response
                    const errorText = await response.text(); // Get response body as text
                    console.error(`HTTP error! Status: ${response.status}, Status Text: ${response.statusText}, Response Body: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                currentReport = await response.json();
                console.log('Report data loaded successfully:', currentReport); // Log the loaded data
                
                renderReportView(currentReport);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('reportContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('loadingSection').innerHTML = `
                    <div class="empty-state">
                        <span class="icon">⚠️</span>
                        <h3>Error Loading Report</h3>
                        <p>Failed to load report data. Please check the console for more details.</p>
                        <a href="/" class="action-btn" style="margin-top: 1rem;">← Back to Dashboard</a>
                    </div>
                `;
            }
        }

        function renderReportView(report) {
            // Update header
            document.getElementById('reportTitle').textContent = `${report.portfolioName} - Sprint ${report.sprintNumber}`;
            document.getElementById('reportSubtitle').textContent = `${report.projectName} | Version ${report.reportVersion} | ${formatDate(report.reportDate)}`;

            // Render cover information
            renderCoverInfo(report);
            
            // Render test summary
            renderTestSummary(report);
            
            // Render metrics overview
            renderMetricsOverview(report);
            
            // Render charts and tables
            renderUserStoriesView(report);
            renderTestCasesView(report);
            renderIssuesView(report); // This function now handles both priority and status
            renderEnhancementsView(report);
            
            // Render additional sections
            renderAdditionalInfo(report);
            renderQANotes(report);
        }

        function renderCoverInfo(report) {
            const coverInfo = document.getElementById('coverInfo');
            coverInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Portfolio Name</div>
                    <div class="info-value">${report.portfolioName || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Project Name</div>
                    <div class="info-value">${report.projectName || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sprint Number</div>
                    <div class="info-value">#${report.sprintNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Version</div>
                    <div class="info-value">v${report.reportVersion || '1.0'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Release Number</div>
                    <div class="info-value">${report.releaseNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cycle Number</div>
                    <div class="info-value">${report.cycleNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Date</div>
                    <div class="info-value">${formatDate(report.reportDate)}</div>
                </div>
            `;
        }

        function renderTestSummary(report) {
            const testSummaryContent = document.getElementById('testSummaryContent');
            testSummaryContent.innerHTML = `
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Testing Status</div>
                    <div class="info-value">
                        <span class="status-badge status-${getStatusClass(report.testingStatus)}">${getStatusText(report.testingStatus)}</span>
                    </div>
                </div>
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Test Summary</div>
                    <div class="info-value">${report.testSummary || 'No summary provided'}</div>
                </div>
            `;
        }

        function renderMetricsOverview(report) {
            const metricsOverview = document.getElementById('metricsOverview');
            metricsOverview.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Total User Stories</div>
                    <div class="info-value metric-highlight">${report.totalUserStories || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Test Cases</div>
                    <div class="info-value metric-highlight">${report.totalTestCases || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Issues</div>
                    <div class="info-value metric-highlight">${report.totalIssues || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Enhancements</div>
                    <div class="info-value metric-highlight">${report.totalEnhancements || 0}</div>
                </div>
            `;
        }

        function renderUserStoriesView(report) {
            const table = document.getElementById('userStoriesViewTable');
            const total = report.totalUserStories || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total User Stories</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.passedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Passed with Issues</td>
                        <td>${report.passedWithIssuesUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedWithIssuesUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.failedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.failedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Blocked</td>
                        <td>${report.blockedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.blockedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Cancelled</td>
                        <td>${report.cancelledUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.cancelledUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Testable</td>
                        <td>${report.notTestableUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notTestableUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('userStoriesViewChart').getContext('2d');
            if (viewCharts.userStories) viewCharts.userStories.destroy();
            
            viewCharts.userStories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedUserStories || 0,
                            report.passedWithIssuesUserStories || 0,
                            report.failedUserStories || 0,
                            report.blockedUserStories || 0,
                            report.cancelledUserStories || 0,
                            report.deferredUserStories || 0,
                            report.notTestableUserStories || 0
                        ],
                        backgroundColor: [
                            '#4CAF50', // Green - Passed
                            '#FFC107', // Amber - Passed with Issues
                            '#F44336', // Red - Failed
                            '#9E9E9E', // Grey - Blocked
                            '#2196F3', // Blue - Cancelled
                            '#673AB7', // Deep Purple - Deferred
                            '#00BCD4'  // Cyan - Not Testable
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderTestCasesView(report) {
            const table = document.getElementById('testCasesViewTable');
            const total = report.totalTestCases || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Test Cases</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.passedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Passed with Issues</td>
                        <td>${report.passedWithIssuesTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedWithIssuesTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.failedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.failedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Blocked</td>
                        <td>${report.blockedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.blockedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Cancelled</td>
                        <td>${report.cancelledTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.cancelledTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Testable</td>
                        <td>${report.notTestableTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notTestableTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('testCasesViewChart').getContext('2d');
            if (viewCharts.testCases) viewCharts.testCases.destroy();
            
            viewCharts.testCases = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedTestCases || 0,
                            report.passedWithIssuesTestCases || 0,
                            report.failedTestCases || 0,
                            report.blockedTestCases || 0,
                            report.cancelledTestCases || 0,
                            report.deferredTestCases || 0,
                            report.notTestableTestCases || 0
                        ],
                        backgroundColor: [
                            '#8BC34A', // Light Green - Passed
                            '#FFEB3B', // Yellow - Passed with Issues
                            '#E91E63', // Pink - Failed
                            '#607D8B', // Blue Grey - Blocked
                            '#9C27B0', // Purple - Cancelled
                            '#FF5722', // Deep Orange - Deferred
                            '#795548'  // Brown - Not Testable
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderIssuesView(report) {
            const priorityTable = document.getElementById('issuesPriorityViewTable');
            const statusTable = document.getElementById('issuesStatusViewTable');
            const total = report.totalIssues || 0;
            
            // Priority table
            priorityTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Issues</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Critical</td>
                        <td>${report.criticalIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.criticalIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>High</td>
                        <td>${report.highIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.highIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Medium</td>
                        <td>${report.mediumIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.mediumIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Low</td>
                        <td>${report.lowIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.lowIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Status table
            statusTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>New</td>
                        <td>${report.newIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.newIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Fixed</td>
                        <td>${report.fixedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.fixedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Fixed</td>
                        <td>${report.notFixedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notFixedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Re-opened</td>
                        <td>${report.reopenedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.reopenedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Priority chart with more vibrant colors
            const priorityCtx = document.getElementById('issuesPriorityViewChart').getContext('2d');
            if (viewCharts.issuesPriority) viewCharts.issuesPriority.destroy();
            
            viewCharts.issuesPriority = new Chart(priorityCtx, {
                type: 'doughnut', // Changed to doughnut for consistency with other charts
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [
                            report.criticalIssues || 0,
                            report.highIssues || 0,
                            report.mediumIssues || 0,
                            report.lowIssues || 0
                        ],
                        backgroundColor: [
                            '#F44336', // Red - Critical
                            '#FF9800', // Orange - High
                            '#FFC107', // Amber - Medium
                            '#4CAF50'  // Green - Low
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });

            // Status chart with more vibrant colors
            const statusCtx = document.getElementById('issuesStatusViewChart').getContext('2d');
            if (viewCharts.issuesStatus) viewCharts.issuesStatus.destroy();
            
            viewCharts.issuesStatus = new Chart(statusCtx, {
                type: 'doughnut', // Changed to doughnut for consistency with other charts
                data: {
                    labels: ['New', 'Fixed', 'Not Fixed', 'Re-opened', 'Deferred'],
                    datasets: [{
                        data: [
                            report.newIssues || 0,
                            report.fixedIssues || 0,
                            report.notFixedIssues || 0,
                            report.reopenedIssues || 0,
                            report.deferredIssues || 0
                        ],
                        backgroundColor: [
                            '#2196F3', // Blue - New
                            '#4CAF50', // Green - Fixed
                            '#E91E63', // Pink - Not Fixed
                            '#FF5722', // Deep Orange - Re-opened
                            '#673AB7'  // Deep Purple - Deferred
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderEnhancementsView(report) {
            const table = document.getElementById('enhancementsViewTable');
            const total = report.totalEnhancements || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Enhancements</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>New</td>
                        <td>${report.newEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.newEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Implemented</td>
                        <td>${report.implementedEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.implementedEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Exists</td>
                        <td>${report.existsEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.existsEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('enhancementsViewChart').getContext('2d');
            if (viewCharts.enhancements) viewCharts.enhancements.destroy();
            
            viewCharts.enhancements = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Implemented', 'Exists'],
                    datasets: [{
                        data: [
                            report.newEnhancements || 0,
                            report.implementedEnhancements || 0,
                            report.existsEnhancements || 0
                        ],
                        backgroundColor: [
                            '#00BCD4', // Cyan - New
                            '#4CAF50', // Green - Implemented
                            '#9E9E9E'  // Grey - Exists
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderAdditionalInfo(report) {
            const section = document.getElementById('additionalInfoSection');
            let content = '';

            // Requests
            if (report.requestData && report.requestData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">📋 Request Information</h3>
                    <div class="dynamic-list">
                        ${report.requestData.map(req => `
                            <div class="dynamic-item">
                                <strong>ID:</strong> ${req.id}<br>
                                <strong>URL:</strong> ${req.url}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Builds
            if (report.buildData && report.buildData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">🏗️ Build Information</h3>
                    <div class="dynamic-list">
                        ${report.buildData.map(build => `
                            <div class="dynamic-item">
                                <strong>Request ID:</strong> ${build.requestId}<br>
                                <strong>URL:</strong> ${build.requestUrl}<br>
                                <strong>Environment:</strong> ${build.environment}<br>
                                <strong>Cycles:</strong> ${build.cycles}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Testers
            if (report.testerData && report.testerData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">🧪 Tester Information</h3>
                    <div class="dynamic-list">
                        ${report.testerData.map(tester => `
                            <div class="dynamic-item">
                                <strong>Tester:</strong> ${tester.name}
                                ${tester.email ? `<br><strong>Email:</strong> ${tester.email}` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Team Members
            if (report.teamMemberData && report.teamMemberData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">👥 Team Members</h3>
                    <div class="dynamic-list">
                        ${report.teamMemberData.map(member => `
                            <div class="dynamic-item">
                                <strong>Member:</strong> ${member.name}
                                ${member.email ? `<br><strong>Email:</strong> ${member.email}` : ''}
                                ${member.role ? `<br><strong>Role:</strong> ${member.role}` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Custom Fields - REMOVED
            // if (report.customFields && Object.keys(report.customFields).length > 0) {
            //     content += `
            //         <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">⚙️ Custom Fields</h3>
            //         <div class="dynamic-list">
            //             ${Object.entries(report.customFields).map(([key, value]) => `
            //                 <div class="dynamic-item">
            //                     <strong>${key}:</strong> ${value}
            //                 </div>
            //             `).join('')}
            //         </div>
            //     `;
            // }

            if (!content) {
                content = '<div class="empty-state"><h3>No Additional Information Provided</h3><p>This report does not contain any extra details.</p></div>';
            }

            section.innerHTML = `<h2 class="section-title">Additional Information</h2>${content}`;
        }

        function renderQANotes(report) {
            const qaNotesContent = document.getElementById('qaNotesContent');
            const qaNotesText = report.qaNotesText || '';

            if (qaNotesText.trim()) {
                qaNotesContent.innerHTML = `<div class="dynamic-item">${qaNotesText}</div>`;
            } else {
                qaNotesContent.innerHTML = `<div class="empty-state" style="border: none; padding: 0; background: none;">
                    <h3 data-i18n="no_qa_notes">No QA Notes</h3>
                    <p data-i18n="no_qa_notes_provided">No specific QA notes were provided for this report.</p>
                </div>`;
            }
            
            // Apply translations to the newly added content
            if (window.translateDynamicContent) {
                window.translateDynamicContent(qaNotesContent);
            }
        }

        function getViewChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            padding: 15, 
                            usePointStyle: true, 
                            font: { 
                                size: 10,
                                family: 'Poppins' // Use Poppins font
                            },
                            color: '#f1f5f9' // Directly set to --text-primary hex value for Chart.js visibility
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.parsed || 0;
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        },
                        titleColor: '#f1f5f9', // Directly set to --text-primary hex value
                        bodyColor: '#f1f5f9',   // Directly set to --text-primary hex value
                        backgroundColor: 'var(--surface)',   // Consistent tooltip background
                        borderColor: 'var(--border)',        // Consistent tooltip border
                        borderWidth: 1,
                        titleFont: { family: 'Poppins' }, // Use Poppins font
                        bodyFont: { family: 'Poppins' } // Use Poppins font
                    }
                }
            };
        }

        function getBarChartOptions(yAxisLabel) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                        },
                        titleColor: '#f1f5f9',
                        bodyColor: '#f1f5f9',
                        backgroundColor: 'var(--surface)',
                        borderColor: 'var(--border)',
                        borderWidth: 1,
                        titleFont: { family: 'Poppins' }, // Use Poppins font
                        bodyFont: { family: 'Poppins' } // Use Poppins font
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'var(--text-secondary)',
                            font: { family: 'Poppins' } // Use Poppins font
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.5)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'var(--text-secondary)',
                            font: { family: 'Poppins' } // Use Poppins font
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.5)'
                        },
                        title: {
                            display: true,
                            text: yAxisLabel,
                            color: 'var(--text-primary)',
                            font: { family: 'Poppins' } // Use Poppins font
                        }
                    }
                }
            };
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString.includes('-') && dateString.length === 10 ? 
                dateString.split('-').reverse().join('-') : dateString);
            return isNaN(date) ? 'Invalid Date' : date.toLocaleDateString('en-GB');
        }

        function getStatusClass(status) {
            const map = { 
                'passed': 'completed', 
                'passed-with-issues': 'in-progress',
                'failed': 'pending', // Consider a 'failed' specific class if needed
                'blocked': 'pending',
                'cancelled': 'pending',
                'deferred': 'pending',
                'not-testable': 'pending'
            };
            return map[status] || 'pending';
        }

        function getStatusText(status) {
            const map = { 
                'passed': 'Passed', 
                'passed-with-issues': 'Passed w/ Issues', 
                'failed': 'Failed', 
                'blocked': 'Blocked', 
                'cancelled': 'Cancelled', 
                'deferred': 'Deferred', 
                'not-testable': 'Not Testable' 
            };
            return map[status] || 'Pending';
        }

        function editCurrentReport() {
            if (!currentReport) {
                showCustomMessageBox('Report data not loaded yet.');
                return;
            }
            
            // Redirect to create report page with edit mode
            window.location.href = `/create-report?id=${currentReport.id}`;
        }

        function deleteCurrentReport() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }

            if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                fetch(`/api/reports/${currentReport.id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            showSuccessToast('Report deleted successfully!');
                            setTimeout(() => {
                                window.location.href = '/reports';
                            }, 1500);
                        } else {
                            showErrorToast('Failed to delete report.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting report:', error);
                        showErrorToast('An error occurred while deleting the report.');
                    });
            }
        }

        async function exportCurrentReportAsPdf() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }
            
            showInfoToast('Generating PDF export...');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPos = margin;

            // Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('QA Testing Report', pageWidth / 2, yPos, { align: 'center' });
            yPos += 25;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${currentReport.portfolioName} - Sprint ${currentReport.sprintNumber}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;
            doc.text(`${currentReport.projectName} | Version ${currentReport.reportVersion} | ${formatDate(currentReport.reportDate)}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 30;

            // General Information
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('General Information', margin, yPos);
            yPos += 20;

            const coverData = [
                ['Portfolio Name', currentReport.portfolioName || 'N/A'],
                ['Project Name', currentReport.projectName || 'N/A'],
                ['Sprint Number', `#${currentReport.sprintNumber || 'N/A'}`],
                ['Report Version', `v${currentReport.reportVersion || '1.0'}`],
                ['Release Number', currentReport.releaseNumber || 'N/A'],
                ['Cycle Number', currentReport.cycleNumber || 'N/A'],
                ['Report Date', formatDate(currentReport.reportDate)],
                ['Testing Status', getStatusText(currentReport.testingStatus)]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Field', 'Value']],
                body: coverData,
                theme: 'grid',
                headStyles: { fillColor: [22, 163, 74] },
                margin: { left: margin, right: margin }
            });
            yPos = doc.lastAutoTable.finalY + 30;

            // Charts
            const chartIds = ['userStoriesViewChart', 'testCasesViewChart', 'issuesPriorityViewChart', 'issuesStatusViewChart', 'enhancementsViewChart'];
            const chartTitles = ['User Stories Distribution', 'Test Cases Distribution', 'Issues by Priority', 'Issues by Status', 'Enhancements Distribution'];

            for (let i = 0; i < chartIds.length; i++) {
                const chartId = chartIds[i];
                const chartTitle = chartTitles[i];
                const canvas = document.getElementById(chartId);

                if (canvas) {
                    if (yPos + 250 > pageHeight) {
                        doc.addPage();
                        yPos = margin;
                    }

                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(chartTitle, margin, yPos);
                    yPos += 20;

                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', margin, yPos, 500, 250);
                    yPos += 280;
                }
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
            }

            doc.save(`QA_Report_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}.pdf`);
            showSuccessToast('PDF export completed successfully!');
        }

        function exportCurrentReportAsExcel() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }
            
            showInfoToast('Generating Excel export...');
            
            // Use the same comprehensive Excel export as the main function
            const workbook = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ["Field", "Value"],
                ["Portfolio Name", currentReport.portfolioName || 'N/A'],
                ["Project Name", currentReport.projectName || 'N/A'],
                ["Sprint Number", currentReport.sprintNumber || 'N/A'],
                ["Report Version", currentReport.reportVersion || 'N/A'],
                ["Cycle Number", currentReport.cycleNumber || 'N/A'],
                ["Report Date", formatDate(currentReport.reportDate)],
                ["Testing Status", getStatusText(currentReport.testingStatus)],
                ["Test Summary", currentReport.testSummary || 'N/A'],
                ["", ""],
                ["METRICS", ""],
                ["Total User Stories", currentReport.totalUserStories || 0],
                ["Total Test Cases", currentReport.totalTestCases || 0],
                ["Total Issues", currentReport.totalIssues || 0],
                ["Total Enhancements", currentReport.totalEnhancements || 0],
                ["QA Notes", currentReport.qaNotesText || 'N/A']
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, wsSummary, "Summary");

            // User Stories Sheet
            const userStoriesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.passedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.passedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Passed with Issues", currentReport.passedWithIssuesUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.passedWithIssuesUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Failed", currentReport.failedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.failedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Blocked", currentReport.blockedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.blockedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Cancelled", currentReport.cancelledUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.cancelledUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Deferred", currentReport.deferredUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.deferredUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Not Testable", currentReport.notTestableUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.notTestableUserStories || 0) / currentReport.totalUserStories) * 100) : 0]
            ];
            const wsUserStories = XLSX.utils.aoa_to_sheet(userStoriesData);
            XLSX.utils.book_append_sheet(workbook, wsUserStories, "User Stories");

            // Test Cases Sheet
            const testCasesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.passedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.passedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Passed with Issues", currentReport.passedWithIssuesTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.passedWithIssuesTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Failed", currentReport.failedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.failedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Blocked", currentReport.blockedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.blockedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Cancelled", currentReport.cancelledTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.cancelledTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Deferred", currentReport.deferredTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.deferredTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Not Testable", currentReport.notTestableTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.notTestableTestCases || 0) / currentReport.totalTestCases) * 100) : 0]
            ];
            const wsTestCases = XLSX.utils.aoa_to_sheet(testCasesData);
            XLSX.utils.book_append_sheet(workbook, wsTestCases, "Test Cases");

            // Issues Sheet
            const issuesData = [
                ["Priority/Status", "Count", "Percentage"],
                ["", "", ""],
                ["PRIORITY BREAKDOWN", "", ""],
                ["Critical", currentReport.criticalIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.criticalIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["High", currentReport.highIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.highIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Medium", currentReport.mediumIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.mediumIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Low", currentReport.lowIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.lowIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["", "", ""],
                ["STATUS BREAKDOWN", "", ""],
                ["New", currentReport.newIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.newIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Fixed", currentReport.fixedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.fixedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Not Fixed", currentReport.notFixedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.notFixedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Re-opened", currentReport.reopenedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.reopenedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Deferred", currentReport.deferredIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.deferredIssues || 0) / currentReport.totalIssues) * 100) : 0]
            ];
            const wsIssues = XLSX.utils.aoa_to_sheet(issuesData);
            XLSX.utils.book_append_sheet(workbook, wsIssues, "Issues");

            // Enhancements Sheet
            const enhancementsData = [
                ["Status", "Count", "Percentage"],
                ["New", currentReport.newEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.newEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0],
                ["Implemented", currentReport.implementedEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.implementedEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0],
                ["Exists", currentReport.existsEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.existsEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0]
            ];
            const wsEnhancements = XLSX.utils.aoa_to_sheet(enhancementsData);
            XLSX.utils.book_append_sheet(workbook, wsEnhancements, "Enhancements");

            // Add all the additional sheets like in the main function - REMOVED evaluation
            // if (currentReport.evaluationData && Object.keys(currentReport.evaluationData).length > 0) {
            //     const evaluationHeaders = ["Evaluation Criteria", "Score", "Weight", "Weighted Score"];
            //     const evaluationSheetData = [];
            //     
            //     for (const [key, value] of Object.entries(currentReport.evaluationData)) {
            //         if (key.includes('_score')) {
            //             const criteriaName = key.replace('_score', '').replace(/_/g, ' ').toUpperCase();
            //             const weightKey = key.replace('_score', '_weight');
            //             const weight = currentReport.evaluationData[weightKey] || 1;
            //             const weightedScore = (value || 0) * weight;
            //             evaluationSheetData.push([criteriaName, value || 0, weight, weightedScore]);
            //         }
            //     }
            //     
            //     if (evaluationSheetData.length > 0) {
            //         evaluationSheetData.unshift(["", "", "", ""]);
            //         evaluationSheetData.unshift(["TOTAL EVALUATION SCORE", "", "", currentReport.evaluationTotalScore || 0]);
            //         const wsEvaluation = XLSX.utils.aoa_to_sheet([evaluationHeaders, ...evaluationSheetData]);
            //         XLSX.utils.book_append_sheet(workbook, wsEvaluation, "Evaluation");
            //     }
            // }

            // Dynamic Data Sheets
            if (currentReport.requestData && currentReport.requestData.length > 0) {
                const requestHeaders = ["Request ID", "URL"];
                const requestsSheetData = currentReport.requestData.map(req => [req.id, req.url]);
                const wsRequests = XLSX.utils.aoa_to_sheet([requestHeaders, ...requestsSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsRequests, "Requests");
            }

            if (currentReport.buildData && currentReport.buildData.length > 0) {
                const buildHeaders = ["Request ID", "URL", "Environment", "Cycles"];
                const buildsSheetData = currentReport.buildData.map(build => [build.requestId, build.requestUrl, build.environment, build.cycles]);
                const wsBuilds = XLSX.utils.aoa_to_sheet([buildHeaders, ...buildsSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsBuilds, "Builds");
            }

            if (currentReport.testerData && currentReport.testerData.length > 0) {
                const testerHeaders = ["Tester Name", "Email"];
                const testersSheetData = currentReport.testerData.map(tester => [tester.name, tester.email || '']);
                const wsTesters = XLSX.utils.aoa_to_sheet([testerHeaders, ...testersSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsTesters, "Testers");
            }

            if (currentReport.teamMemberData && currentReport.teamMemberData.length > 0) {
                const teamHeaders = ["Team Member Name", "Email", "Role"];
                const teamSheetData = currentReport.teamMemberData.map(member => [member.name, member.email || '', member.role || '']);
                const wsTeam = XLSX.utils.aoa_to_sheet([teamHeaders, ...teamSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsTeam, "Team Members");
            }

            // Custom Fields - REMOVED
            // if (currentReport.customFields && Object.keys(currentReport.customFields).length > 0) {
            //     const customFieldsHeaders = ["Field Name", "Value"];
            //     const customFieldsSheetData = Object.entries(currentReport.customFields).map(([key, value]) => [key, value]);
            //     const wsCustomFields = XLSX.utils.aoa_to_sheet([customFieldsHeaders, ...customFieldsSheetData]);
            //     XLSX.utils.book_append_sheet(workbook, wsCustomFields, "Custom Fields");
            // }

            XLSX.writeFile(workbook, `QA_Report_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}_Complete.xlsx`);
            showSuccessToast('Excel export completed successfully!');
        }

        async function exportStyledReportAsPdf() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }
            
            showInfoToast('Generating styled PDF export...');

            // Get the view report page content
            const reportContent = document.querySelector('.container');
            if (!reportContent) {
                showErrorToast('Report content not found.');
                return;
            }

            // Capture charts as images
            const chartImages = {};
            try {
                const userStoriesChart = Chart.getChart('userStoriesViewChart');
                const testCasesChart = Chart.getChart('testCasesViewChart');
                const issuesPriorityChart = Chart.getChart('issuesPriorityViewChart');
                const issuesStatusChart = Chart.getChart('issuesStatusViewChart');
                const enhancementsChart = Chart.getChart('enhancementsViewChart');

                if (userStoriesChart) {
                    chartImages.userStories = userStoriesChart.toBase64Image('image/png', 1.0);
                }
                if (testCasesChart) {
                    chartImages.testCases = testCasesChart.toBase64Image('image/png', 1.0);
                }
                if (issuesPriorityChart) {
                    chartImages.issuesPriority = issuesPriorityChart.toBase64Image('image/png', 1.0);
                }
                if (issuesStatusChart) {
                    chartImages.issuesStatus = issuesStatusChart.toBase64Image('image/png', 1.0);
                }
                if (enhancementsChart) {
                    chartImages.enhancements = enhancementsChart.toBase64Image('image/png', 1.0);
                }
            } catch (error) {
                console.log('Some charts may not be available:', error);
            }

            // Create a new window for the styled PDF export
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QA Report - ${currentReport.portfolioName} Sprint ${currentReport.sprintNumber}</title>
                    <style>
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body { 
                            font-family: 'Poppins', sans-serif; 
                            line-height: 1.4; 
                            color: #1e293b; 
                            background: linear-gradient(to bottom, #ffffff, #f8fafc);
                            padding: 0;
                            font-size: 14px;
                        }
                        
                        .page-container {
                            max-width: 210mm;
                            margin: 0 auto;
                            padding: 20mm;
                            min-height: 297mm;
                            background: linear-gradient(to bottom, #ffffff, #f8fafc);
                        }
                        
                        .header { 
                            text-align: center; 
                            margin-bottom: 40px; 
                            padding: 30px 0;
                            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
                            color: #ffffff;
                            border-radius: 15px;
                            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                            border: 1px solid #e2e8f0;
                        }
                        
                        .header h1 { 
                            font-size: 2.8em; 
                            margin-bottom: 10px;
                            font-weight: 700;
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                        }
                        
                        .header .subtitle { 
                            font-size: 1.3em; 
                            font-weight: 400;
                            margin-bottom: 5px;
                            opacity: 0.9;
                        }
                        
                        .header .project-info { 
                            font-size: 1.1em; 
                            font-weight: 300;
                            opacity: 0.8;
                        }
                        
                        .executive-summary {
                            background: rgba(248, 250, 252, 0.8);
                            border-radius: 12px;
                            padding: 25px;
                            margin: 30px 0;
                            border-left: 5px solid #3b82f6;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                            border: 1px solid #e2e8f0;
                        }
                        
                        .executive-summary h2 {
                            color: #1e293b;
                            font-size: 1.8em;
                            margin-bottom: 20px;
                            font-weight: 600;
                        }
                        
                        .metrics-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                            gap: 20px;
                            margin: 20px 0;
                        }
                        
                        .metric-card {
                            background: rgba(255, 255, 255, 0.8);
                            border-radius: 10px;
                            padding: 20px;
                            text-align: center;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            border: 1px solid #3b82f6;
                        }
                        
                        .metric-card .metric-value {
                            font-size: 2.2em;
                            font-weight: 700;
                            color: #3b82f6;
                            margin-bottom: 8px;
                        }
                        
                        .metric-card .metric-label {
                            font-size: 0.9em;
                            color: #64748b;
                            font-weight: 500;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .section {
                            margin: 40px 0;
                            page-break-inside: avoid;
                        }
                        
                        .section-title {
                            font-size: 1.6em;
                            font-weight: 600;
                            color: #1e293b;
                            margin-bottom: 20px;
                            padding-bottom: 10px;
                            border-bottom: 3px solid #3b82f6;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin: 20px 0;
                        }
                        
                        .info-item {
                            background: rgba(255, 255, 255, 0.8);
                            padding: 15px;
                            border-radius: 8px;
                            border-left: 4px solid #3b82f6;
                            border: 1px solid #e2e8f0;
                        }
                        
                        .info-label {
                            font-weight: 600;
                            color: #3b82f6;
                            font-size: 0.9em;
                            margin-bottom: 5px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .info-value {
                            font-size: 1.1em;
                            color: #1e293b;
                            font-weight: 500;
                        }
                        
                        .chart-section {
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                            margin: 30px 0;
                            page-break-inside: avoid;
                        }
                        
                        .chart-container {
                            width: 100%;
                            text-align: center;
                            background: rgba(255, 255, 255, 0.8);
                            border-radius: 8px;
                            padding: 20px;
                            border: 1px solid #e2e8f0;
                        }
                        
                        .chart-container h3 {
                            color: #1e293b;
                            margin-bottom: 15px;
                            font-size: 1.2em;
                        }
                        
                        .chart-container img {
                            max-width: 100%;
                            height: auto;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        }
                        
                        .data-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 0.9em;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            background: rgba(255, 255, 255, 0.8);
                            border: 1px solid #e2e8f0;
                        }
                        
                        .data-table th {
                            background: #3b82f6;
                            color: #ffffff;
                            padding: 12px;
                            text-align: left;
                            font-weight: 600;
                            font-size: 0.85em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .data-table td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #e2e8f0;
                            background: rgba(248, 250, 252, 0.8);
                            color: #1e293b;
                        }
                        
                        .data-table tr:nth-child(even) td {
                            background: rgba(241, 245, 249, 0.8);
                        }
                        
                        .percentage-cell {
                            text-align: center;
                            font-weight: 600;
                            color: #3b82f6;
                        }
                        
                        .test-summary {
                            background: rgba(248, 250, 252, 0.8);
                            border-radius: 12px;
                            padding: 25px;
                            margin: 30px 0;
                            border-left: 5px solid #eab308;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                            border: 1px solid #e2e8f0;
                        }
                        
                        .test-summary h3 {
                            color: #eab308;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .test-summary p {
                            color: #1e293b;
                            line-height: 1.6;
                            font-size: 1em;
                        }
                        
                        .qa-notes {
                            background: rgba(248, 250, 252, 0.8);
                            border-radius: 12px;
                            padding: 25px;
                            margin: 30px 0;
                            border-left: 5px solid #22c55e;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                            border: 1px solid #e2e8f0;
                        }
                        
                        .qa-notes h3 {
                            color: #22c55e;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .qa-notes p {
                            color: #1e293b;
                            line-height: 1.6;
                            font-size: 1em;
                        }
                        
                        .footer {
                            margin-top: 50px;
                            padding-top: 20px;
                            border-top: 2px solid #e2e8f0;
                            text-align: center;
                            color: #64748b;
                            font-size: 0.9em;
                        }
                        
                        @media print {
                            .page-container { 
                                margin: 0; 
                                padding: 15mm;
                                max-width: none;
                            }
                            .section { 
                                page-break-inside: avoid; 
                            }
                            .chart-section { 
                                page-break-inside: avoid; 
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="page-container">
                        <!-- Header -->
                        <div class="header">
                            <h1>QA Testing Report</h1>
                            <div class="subtitle">${currentReport.portfolioName} - Sprint ${currentReport.sprintNumber}</div>
                            <div class="project-info">${currentReport.projectName} | Version ${currentReport.reportVersion} | ${formatDate(currentReport.reportDate)}</div>
                        </div>
                        
                        <!-- Executive Summary -->
                        <div class="executive-summary">
                            <h2>Executive Summary</h2>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-value">${currentReport.totalUserStories || 0}</div>
                                    <div class="metric-label">User Stories</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${currentReport.totalTestCases || 0}</div>
                                    <div class="metric-label">Test Cases</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${currentReport.totalIssues || 0}</div>
                                    <div class="metric-label">Issues</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${currentReport.totalEnhancements || 0}</div>
                                    <div class="metric-label">Enhancements</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- General Information -->
                        <div class="section">
                            <h2 class="section-title">General Information</h2>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Portfolio</div>
                                    <div class="info-value">${currentReport.portfolioName || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Project</div>
                                    <div class="info-value">${currentReport.projectName || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Sprint Number</div>
                                    <div class="info-value">#${currentReport.sprintNumber || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Report Version</div>
                                    <div class="info-value">v${currentReport.reportVersion || '1.0'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Release Number</div>
                                    <div class="info-value">${currentReport.releaseNumber || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Cycle Number</div>
                                    <div class="info-value">${currentReport.cycleNumber || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Report Date</div>
                                    <div class="info-value">${formatDate(currentReport.reportDate)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Testing Status</div>
                                    <div class="info-value">${getStatusText(currentReport.testingStatus)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Section -->
                        <div class="section">
                            <h2 class="section-title">Analysis</h2>
                            <div class="grid-container">
                                <!-- User Stories Analysis -->
                                <div class="grid-item">
                                    <h3>User Stories Analysis</h3>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Status</th>
                                                <th>Count</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>Total</strong></td>
                                                <td>${currentReport.totalUserStories || 0}</td>
                                                <td class="percentage-cell">100%</td>
                                            </tr>
                                            <tr>
                                                <td>Passed</td>
                                                <td>${currentReport.passedUserStories || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalUserStories ? Math.round(((currentReport.passedUserStories || 0) / currentReport.totalUserStories) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Passed with Issues</td>
                                                <td>${currentReport.passedWithIssuesUserStories || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalUserStories ? Math.round(((currentReport.passedWithIssuesUserStories || 0) / currentReport.totalUserStories) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Failed</td>
                                                <td>${currentReport.failedUserStories || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalUserStories ? Math.round(((currentReport.failedUserStories || 0) / currentReport.totalUserStories) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Blocked</td>
                                                <td>${currentReport.blockedUserStories || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalUserStories ? Math.round(((currentReport.blockedUserStories || 0) / currentReport.totalUserStories) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Other</td>
                                                <td>${(currentReport.cancelledUserStories || 0) + (currentReport.deferredUserStories || 0) + (currentReport.notTestableUserStories || 0)}</td>
                                                <td class="percentage-cell">${currentReport.totalUserStories ? Math.round((((currentReport.cancelledUserStories || 0) + (currentReport.deferredUserStories || 0) + (currentReport.notTestableUserStories || 0)) / currentReport.totalUserStories) * 100) : 0}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Test Cases Analysis -->
                                <div class="grid-item">
                                    <h3>Test Cases Analysis</h3>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Status</th>
                                                <th>Count</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>Total</strong></td>
                                                <td>${currentReport.totalTestCases || 0}</td>
                                                <td class="percentage-cell">100%</td>
                                            </tr>
                                            <tr>
                                                <td>Passed</td>
                                                <td>${currentReport.passedTestCases || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalTestCases ? Math.round(((currentReport.passedTestCases || 0) / currentReport.totalTestCases) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Passed with Issues</td>
                                                <td>${currentReport.passedWithIssuesTestCases || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalTestCases ? Math.round(((currentReport.passedWithIssuesTestCases || 0) / currentReport.totalTestCases) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Failed</td>
                                                <td>${currentReport.failedTestCases || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalTestCases ? Math.round(((currentReport.failedTestCases || 0) / currentReport.totalTestCases) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Blocked</td>
                                                <td>${currentReport.blockedTestCases || 0}</td>
                                                <td class="percentage-cell">${currentReport.totalTestCases ? Math.round(((currentReport.blockedTestCases || 0) / currentReport.totalTestCases) * 100) : 0}%</td>
                                            </tr>
                                            <tr>
                                                <td>Other</td>
                                                <td>${(currentReport.cancelledTestCases || 0) + (currentReport.deferredTestCases || 0) + (currentReport.notTestableTestCases || 0)}</td>
                                                <td class="percentage-cell">${currentReport.totalTestCases ? Math.round((((currentReport.cancelledTestCases || 0) + (currentReport.deferredTestCases || 0) + (currentReport.notTestableTestCases || 0)) / currentReport.totalTestCases) * 100) : 0}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="section">
                            <h2 class="section-title">Visualizations</h2>
                            <div class="grid-container">
                                <div class="grid-item chart-container">
                                    <h3>User Stories Distribution</h3>
                                    ${chartImages.userStories ? `<img src="${chartImages.userStories}" alt="User Stories Chart">` : '<p>Chart not available</p>'}
                                </div>
                                <div class="grid-item chart-container">
                                    <h3>Test Cases Distribution</h3>
                                    ${chartImages.testCases ? `<img src="${chartImages.testCases}" alt="Test Cases Chart">` : '<p>Chart not available</p>'}
                                </div>
                                <div class="grid-item chart-container">
                                    <h3>Issues by Priority</h3>
                                    ${chartImages.issuesPriority ? `<img src="${chartImages.issuesPriority}" alt="Issues Priority Chart">` : '<p>Chart not available</p>'}
                                </div>
                                <div class="grid-item chart-container">
                                    <h3>Issues by Status</h3>
                                    ${chartImages.issuesStatus ? `<img src="${chartImages.issuesStatus}" alt="Issues Status Chart">` : '<p>Chart not available</p>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Summary -->
                        ${currentReport.testSummary ? `
                        <div class="test-summary">
                            <h3>Test Summary</h3>
                            <p>${currentReport.testSummary}</p>
                        </div>
                        ` : ''}
                        
                        <!-- QA Notes -->
                        ${currentReport.qaNotesText ? `
                        <div class="qa-notes">
                            <h3>QA Notes</h3>
                            <p>${currentReport.qaNotesText}</p>
                        </div>
                        ` : ''}
                        
                        <!-- Team Members -->
                        ${currentReport.teamMemberData && currentReport.teamMemberData.length > 0 ? `
                        <div class="test-summary">
                            <h3>Team Members</h3>
                            ${currentReport.teamMemberData.map(member => `
                                <p><strong>${member.name}</strong> - ${member.role || 'N/A'} (${member.email || 'N/A'})</p>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <!-- Custom Fields - REMOVED -->
                        ${/* currentReport.customFields && Object.keys(currentReport.customFields).length > 0 ? `
                        <div class="qa-notes">
                            <h3>Custom Fields</h3>
                            ${Object.entries(currentReport.customFields).map(([key, value]) => `
                                <p><strong>${key}:</strong> ${value}</p>
                            `).join('')}
                        </div>
                        ` : '' */ ''}
                        
                        <!-- Footer -->
                        <div class="footer">
                            <p>Generated on ${new Date().toLocaleDateString('en-GB')} | Sprint Reports System</p>
                        </div>
                    </div>
                </body>
                </html>
            `);

            // Close the document and trigger print
            printWindow.document.close();
            
            // Wait for the content to load, then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    showSuccessToast('Styled PDF export completed successfully!');
                }, 500);
            };
        }

        // Custom Message Box (instead of alert)
        function showCustomMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--surface);
                color: var(--text-primary);
                padding: 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-heavy);
                z-index: 9999;
                text-align: center;
                max-width: 300px;
                border: 1px solid var(--border);
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button onclick="this.parentNode.remove()" style="
                    background: var(--primary);
                    color: var(--text-primary);
                    border: none;
                    padding: 8px 15px;
                    border-radius: var(--border-radius);
                    cursor: pointer;
                    margin-top: 10px;
                ">OK</button>
            `;
            document.body.appendChild(messageBox);
        }
    </script>
    </div>

</body>
</html>
