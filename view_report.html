<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Report View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/static/view_report.css">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-brand"><i class="fas fa-rocket"></i> Sprint Reports System</div>
            <div class="nav-links">
                <a href="/dashboard" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="/reports" class="nav-link active"><i class="fas fa-chart-line"></i> Reports</a>
                <a href="/create-report" class="nav-link"><i class="fas fa-plus-circle"></i> New Report</a>
                <a href="/manage" class="nav-link"><i class="fas fa-cogs"></i> Manage Data</a>
            </div>
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="container card">
            <div class="dashboard-header">
            <h1 id="reportTitle">Sprint Testing Report</h1>
            <p id="reportSubtitle">Loading report details...</p>
            <div class="header-actions">
                <button class="action-btn btn-export-pdf" onclick="exportCurrentReportAsPdf()"><i class="fas fa-file-pdf"></i> Export PDF</button>
                <button class="action-btn btn-export-excel" onclick="exportCurrentReportAsExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
            </div>
        </div>

        <div id="loadingSection" class="empty-state loading">
            <div class="spinner"></div>
            <h3>Loading Report Data...</h3>
            <p>Please wait while we fetch your report.</p>
        </div>

        <div class="report-content" id="reportContent" style="display: none;">
            <div class="section card">
                <h2 class="section-title">General Information</h2>
                <div class="info-grid" id="coverInfo">
                    </div>
            </div>

            <div class="section card">
                <h2 class="section-title">Test Summary & Status</h2>
                <div class="info-grid" id="testSummaryContent">
                    </div>
            </div>

            <div class="section card">
                <h2 class="section-title">Testing Metrics Overview</h2>
                <div class="info-grid" id="metricsOverview">
                    </div>
            </div>

            <div class="section card">
                <h2 class="section-title">User Stories Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">User Stories Summary</h3>
                        <table class="data-table" id="userStoriesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">User Stories Distribution</h3>
                        <div class="chart-container">
                            <canvas id="userStoriesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section card">
                <h2 class="section-title">Test Cases Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Cases Summary</h3>
                        <table class="data-table" id="testCasesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Cases Distribution</h3>
                        <div class="chart-container">
                            <canvas id="testCasesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section card">
                <h2 class="section-title">Issues by Priority</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Priority Breakdown</h3>
                        <table class="data-table" id="issuesPriorityViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Priority Chart</h3>
                        <div class="chart-container" style="margin-top: 20px;">
                            <canvas id="issuesPriorityViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section card">
                <h2 class="section-title">Issues by Status</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Status Breakdown</h3>
                        <table class="data-table" id="issuesStatusViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Status Chart</h3>
                        <div class="chart-container" style="margin-top: 20px;">
                            <canvas id="issuesStatusViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section card">
                <h2 class="section-title">Enhancements Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Enhancements Summary</h3>
                        <table class="data-table" id="enhancementsViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Enhancements Distribution</h3>
                        <div class="chart-container">
                            <canvas id="enhancementsViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section card" id="additionalInfoSection">
                <h2 class="section-title">Additional Information</h2>
                </div>

            <div class="section card" id="qaNotesSection">
                <h2 class="section-title">QA Notes</h2>
                <div class="info-item">
                    <div class="info-label">Additional Notes</div>
                    <div class="info-value" id="qaNotesContent">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentReport = null;
        let viewCharts = {};

        // Get report ID from URL
        const reportId = window.location.pathname.split('/').pop();
        console.log('Attempting to load report ID:', reportId); // Log the ID being used

        // Load report data when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await loadReportData(reportId);
        });

        async function loadReportData(id) {
            try {
                // Ensure the URL is correctly formed and accessible
                const apiUrl = `/api/reports/${id}`;
                console.log('Fetching report from:', apiUrl); // Log the full API URL

                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    // Log detailed error information from the server response
                    const errorText = await response.text(); // Get response body as text
                    console.error(`HTTP error! Status: ${response.status}, Status Text: ${response.statusText}, Response Body: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                currentReport = await response.json();
                console.log('Report data loaded successfully:', currentReport); // Log the loaded data
                
                renderReportView(currentReport);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('reportContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('loadingSection').innerHTML = `
                    <div class="empty-state">
                        <span class="icon">⚠️</span>
                        <h3>Error Loading Report</h3>
                        <p>Failed to load report data. Please check the console for more details.</p>
                        <a href="/" class="action-btn" style="margin-top: 1rem;">← Back to Dashboard</a>
                    </div>
                `;
            }
        }

        function renderReportView(report) {
            // Update header
            document.getElementById('reportTitle').textContent = `${report.portfolioName} - Sprint ${report.sprintNumber}`;
            document.getElementById('reportSubtitle').textContent = `${report.projectName} | Version ${report.reportVersion} | ${formatDate(report.reportDate)}`;

            // Render cover information
            renderCoverInfo(report);
            
            // Render test summary
            renderTestSummary(report);
            
            // Render metrics overview
            renderMetricsOverview(report);
            
            // Render charts and tables
            renderUserStoriesView(report);
            renderTestCasesView(report);
            renderIssuesView(report); // This function now handles both priority and status
            renderEnhancementsView(report);
            
            // Render additional sections
            renderAdditionalInfo(report);
            renderQANotes(report);
        }

        function renderCoverInfo(report) {
            const coverInfo = document.getElementById('coverInfo');
            coverInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Portfolio Name</div>
                    <div class="info-value">${report.portfolioName || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Project Name</div>
                    <div class="info-value">${report.projectName || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sprint Number</div>
                    <div class="info-value">#${report.sprintNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Version</div>
                    <div class="info-value">v${report.reportVersion || '1.0'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Release Number</div>
                    <div class="info-value">${report.releaseNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cycle Number</div>
                    <div class="info-value">${report.cycleNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Date</div>
                    <div class="info-value">${formatDate(report.reportDate)}</div>
                </div>
            `;
        }

        function renderTestSummary(report) {
            const testSummaryContent = document.getElementById('testSummaryContent');
            testSummaryContent.innerHTML = `
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Testing Status</div>
                    <div class="info-value">
                        <span class="status-badge status-${getStatusClass(report.testingStatus)}">${getStatusText(report.testingStatus)}</span>
                    </div>
                </div>
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Test Summary</div>
                    <div class="info-value">${report.testSummary || 'No summary provided'}</div>
                </div>
            `;
        }

        function renderMetricsOverview(report) {
            const metricsOverview = document.getElementById('metricsOverview');
            metricsOverview.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Total User Stories</div>
                    <div class="info-value metric-highlight">${report.totalUserStories || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Test Cases</div>
                    <div class="info-value metric-highlight">${report.totalTestCases || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Issues</div>
                    <div class="info-value metric-highlight">${report.totalIssues || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Enhancements</div>
                    <div class="info-value metric-highlight">${report.totalEnhancements || 0}</div>
                </div>
            `;
        }

        function renderUserStoriesView(report) {
            const table = document.getElementById('userStoriesViewTable');
            const total = report.totalUserStories || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total User Stories</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.passedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Passed with Issues</td>
                        <td>${report.passedWithIssuesUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedWithIssuesUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.failedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.failedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Blocked</td>
                        <td>${report.blockedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.blockedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Cancelled</td>
                        <td>${report.cancelledUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.cancelledUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Testable</td>
                        <td>${report.notTestableUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notTestableUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('userStoriesViewChart').getContext('2d');
            if (viewCharts.userStories) viewCharts.userStories.destroy();
            
            viewCharts.userStories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedUserStories || 0,
                            report.passedWithIssuesUserStories || 0,
                            report.failedUserStories || 0,
                            report.blockedUserStories || 0,
                            report.cancelledUserStories || 0,
                            report.deferredUserStories || 0,
                            report.notTestableUserStories || 0
                        ],
                        backgroundColor: [
                            '#4CAF50', // Green - Passed
                            '#FFC107', // Amber - Passed with Issues
                            '#F44336', // Red - Failed
                            '#9E9E9E', // Grey - Blocked
                            '#2196F3', // Blue - Cancelled
                            '#673AB7', // Deep Purple - Deferred
                            '#00BCD4'  // Cyan - Not Testable
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderTestCasesView(report) {
            const table = document.getElementById('testCasesViewTable');
            const total = report.totalTestCases || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Test Cases</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.passedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Passed with Issues</td>
                        <td>${report.passedWithIssuesTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedWithIssuesTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.failedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.failedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Blocked</td>
                        <td>${report.blockedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.blockedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Cancelled</td>
                        <td>${report.cancelledTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.cancelledTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Testable</td>
                        <td>${report.notTestableTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notTestableTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('testCasesViewChart').getContext('2d');
            if (viewCharts.testCases) viewCharts.testCases.destroy();
            
            viewCharts.testCases = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedTestCases || 0,
                            report.passedWithIssuesTestCases || 0,
                            report.failedTestCases || 0,
                            report.blockedTestCases || 0,
                            report.cancelledTestCases || 0,
                            report.deferredTestCases || 0,
                            report.notTestableTestCases || 0
                        ],
                        backgroundColor: [
                            '#8BC34A', // Light Green - Passed
                            '#FFEB3B', // Yellow - Passed with Issues
                            '#E91E63', // Pink - Failed
                            '#607D8B', // Blue Grey - Blocked
                            '#9C27B0', // Purple - Cancelled
                            '#FF5722', // Deep Orange - Deferred
                            '#795548'  // Brown - Not Testable
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderIssuesView(report) {
            const priorityTable = document.getElementById('issuesPriorityViewTable');
            const statusTable = document.getElementById('issuesStatusViewTable');
            const total = report.totalIssues || 0;
            
            // Priority table
            priorityTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Issues</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Critical</td>
                        <td>${report.criticalIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.criticalIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>High</td>
                        <td>${report.highIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.highIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Medium</td>
                        <td>${report.mediumIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.mediumIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Low</td>
                        <td>${report.lowIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.lowIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Status table
            statusTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>New</td>
                        <td>${report.newIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.newIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Fixed</td>
                        <td>${report.fixedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.fixedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Fixed</td>
                        <td>${report.notFixedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notFixedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Re-opened</td>
                        <td>${report.reopenedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.reopenedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Priority chart with more vibrant colors
            const priorityCtx = document.getElementById('issuesPriorityViewChart').getContext('2d');
            if (viewCharts.issuesPriority) viewCharts.issuesPriority.destroy();
            
            viewCharts.issuesPriority = new Chart(priorityCtx, {
                type: 'doughnut', // Changed to doughnut for consistency with other charts
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [
                            report.criticalIssues || 0,
                            report.highIssues || 0,
                            report.mediumIssues || 0,
                            report.lowIssues || 0
                        ],
                        backgroundColor: [
                            '#F44336', // Red - Critical
                            '#FF9800', // Orange - High
                            '#FFC107', // Amber - Medium
                            '#4CAF50'  // Green - Low
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });

            // Status chart with more vibrant colors
            const statusCtx = document.getElementById('issuesStatusViewChart').getContext('2d');
            if (viewCharts.issuesStatus) viewCharts.issuesStatus.destroy();
            
            viewCharts.issuesStatus = new Chart(statusCtx, {
                type: 'doughnut', // Changed to doughnut for consistency with other charts
                data: {
                    labels: ['New', 'Fixed', 'Not Fixed', 'Re-opened', 'Deferred'],
                    datasets: [{
                        data: [
                            report.newIssues || 0,
                            report.fixedIssues || 0,
                            report.notFixedIssues || 0,
                            report.reopenedIssues || 0,
                            report.deferredIssues || 0
                        ],
                        backgroundColor: [
                            '#2196F3', // Blue - New
                            '#4CAF50', // Green - Fixed
                            '#E91E63', // Pink - Not Fixed
                            '#FF5722', // Deep Orange - Re-opened
                            '#673AB7'  // Deep Purple - Deferred
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderEnhancementsView(report) {
            const table = document.getElementById('enhancementsViewTable');
            const total = report.totalEnhancements || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Enhancements</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>New</td>
                        <td>${report.newEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.newEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Implemented</td>
                        <td>${report.implementedEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.implementedEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Exists</td>
                        <td>${report.existsEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.existsEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('enhancementsViewChart').getContext('2d');
            if (viewCharts.enhancements) viewCharts.enhancements.destroy();
            
            viewCharts.enhancements = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Implemented', 'Exists'],
                    datasets: [{
                        data: [
                            report.newEnhancements || 0,
                            report.implementedEnhancements || 0,
                            report.existsEnhancements || 0
                        ],
                        backgroundColor: [
                            '#00BCD4', // Cyan - New
                            '#4CAF50', // Green - Implemented
                            '#9E9E9E'  // Grey - Exists
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions()
            });
        }

        function renderAdditionalInfo(report) {
            const section = document.getElementById('additionalInfoSection');
            let content = '';

            // Requests
            if (report.requestData && report.requestData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">📋 Request Information</h3>
                    <div class="dynamic-list">
                        ${report.requestData.map(req => `
                            <div class="dynamic-item">
                                <strong>ID:</strong> ${req.id}<br>
                                <strong>URL:</strong> ${req.url}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Builds
            if (report.buildData && report.buildData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">🏗️ Build Information</h3>
                    <div class="dynamic-list">
                        ${report.buildData.map(build => `
                            <div class="dynamic-item">
                                <strong>Request ID:</strong> ${build.requestId}<br>
                                <strong>URL:</strong> ${build.requestUrl}<br>
                                <strong>Environment:</strong> ${build.environment}<br>
                                <strong>Cycles:</strong> ${build.cycles}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Testers
            if (report.testerData && report.testerData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">🧪 Tester Information</h3>
                    <div class="dynamic-list">
                        ${report.testerData.map(tester => `
                            <div class="dynamic-item">
                                <strong>Tester:</strong> ${tester.name}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (!content) {
                content = '<div class="empty-state"><h3>No Additional Information Provided</h3><p>This report does not contain any extra details.</p></div>';
            }

            section.innerHTML = `<h2 class="section-title">Additional Information</h2>${content}`;
        }

        function renderQANotes(report) {
            const qaNotesContent = document.getElementById('qaNotesContent');
            if (report.qaNotesText) {
                qaNotesContent.textContent = report.qaNotesText;
            } else {
                qaNotesContent.innerHTML = `<div class="empty-state" style="border: none; padding: 0; background: none;"><h3>No QA Notes</h3><p>No specific QA notes were provided for this report.</p></div>`;
            }
        }

        function getViewChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            padding: 15, 
                            usePointStyle: true, 
                            font: { size: 10 },
                            color: '#f1f5f9' // Directly set to --text-primary hex value for Chart.js visibility
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.parsed || 0;
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        },
                        titleColor: '#f1f5f9', // Directly set to --text-primary hex value
                        bodyColor: '#f1f5f9',   // Directly set to --text-primary hex value
                        backgroundColor: 'var(--surface)',   // Consistent tooltip background
                        borderColor: 'var(--border)',        // Consistent tooltip border
                        borderWidth: 1
                    }
                }
            };
        }

        function getBarChartOptions(yAxisLabel) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                        },
                        titleColor: '#f1f5f9',
                        bodyColor: '#f1f5f9',
                        backgroundColor: 'var(--surface)',
                        borderColor: 'var(--border)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'var(--text-secondary)'
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.5)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'var(--text-secondary)'
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.5)'
                        },
                        title: {
                            display: true,
                            text: yAxisLabel,
                            color: 'var(--text-primary)'
                        }
                    }
                }
            };
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString.includes('-') && dateString.length === 10 ? 
                dateString.split('-').reverse().join('-') : dateString);
            return isNaN(date) ? 'Invalid Date' : date.toLocaleDateString('en-GB');
        }

        function getStatusClass(status) {
            const map = { 
                'passed': 'completed', 
                'passed-with-issues': 'in-progress',
                'failed': 'pending', // Consider a 'failed' specific class if needed
                'blocked': 'pending',
                'cancelled': 'pending',
                'deferred': 'pending',
                'not-testable': 'pending'
            };
            return map[status] || 'pending';
        }

        function getStatusText(status) {
            const map = { 
                'passed': 'Passed', 
                'passed-with-issues': 'Passed w/ Issues', 
                'failed': 'Failed', 
                'blocked': 'Blocked', 
                'cancelled': 'Cancelled', 
                'deferred': 'Deferred', 
                'not-testable': 'Not Testable' 
            };
            return map[status] || 'Pending';
        }

        async function exportCurrentReportAsPdf() {
            if (!currentReport) {
                // Use a custom message box instead of alert
                showCustomMessageBox('Report data not loaded yet.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Helper function to add charts as images
            async function addChartToPDF(chartId, yPosition, title, width = 170, height = 90) {
                const canvas = document.getElementById(chartId);
                if (canvas && viewCharts[chartId.replace('ViewChart', '').replace('View', '')]) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(title, 10, yPosition);
                    
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, yPosition + 5, width, height);
                    return yPosition + height + 15;
                }
                return yPosition;
            }

            // Helper function to check if we need a new page
            function checkPageBreak(currentY, requiredSpace = 40) {
                if (currentY + requiredSpace > 270) {
                    doc.addPage();
                    return 20;
                }
                return currentY;
            }

            let yPos = 20;

            // Title and Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('QA Testing Report', 105, yPos, { align: 'center' });
            yPos += 15;

            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(`${currentReport.portfolioName} - Sprint ${currentReport.sprintNumber}`, 105, yPos, { align: 'center' });
            yPos += 8;
            doc.text(`${currentReport.projectName} | Version ${currentReport.reportVersion} | ${formatDate(currentReport.reportDate)}`, 105, yPos, { align: 'center' });
            yPos += 20;

            // Cover Information Section
            yPos = checkPageBreak(yPos, 60);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('General Details', 10, yPos);
            yPos += 10;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const coverData = [
                ['Portfolio Name', currentReport.portfolioName || 'N/A'],
                ['Project Name', currentReport.projectName || 'N/A'],
                ['Sprint Number', `#${currentReport.sprintNumber || 'N/A'}`],
                ['Report Version', `v${currentReport.reportVersion || '1.0'}`],
                ['Release Number', currentReport.releaseNumber || 'N/A'],
                ['Cycle Number', currentReport.cycleNumber || 'N/A'],
                ['Report Date', formatDate(currentReport.reportDate)],
                ['Testing Status', getStatusText(currentReport.testingStatus)]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Field', 'Value']],
                body: coverData,
                styles: { fontSize: 9, cellPadding: 3 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 }, // Using primary color
                columnStyles: { 0: { fontStyle: 'bold' } }
            });
            yPos = doc.lastAutoTable.finalY + 15;

            // Test Summary
            if (currentReport.testSummary) {
                yPos = checkPageBreak(yPos, 40);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Test Summary & Status', 10, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const summaryText = doc.splitTextToSize(currentReport.testSummary, 190);
                doc.text(summaryText, 10, yPos);
                yPos += summaryText.length * 6 + 15;
            }

            // Testing Metrics Overview
            yPos = checkPageBreak(yPos, 50);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Testing Metrics Overview', 10, yPos);
            yPos += 10;

            const metricsData = [
                ['Total User Stories', currentReport.totalUserStories || 0],
                ['Total Test Cases', currentReport.totalTestCases || 0],
                ['Total Issues', currentReport.totalIssues || 0],
                ['Total Enhancements', currentReport.totalEnhancements || 0],
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Metric', 'Value']],
                body: metricsData,
                styles: { fontSize: 9, cellPadding: 3 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 }, // Using primary color
                columnStyles: { 0: { fontStyle: 'bold' } }
            });
            yPos = doc.lastAutoTable.finalY + 20;

            // User Stories Analysis with Chart
            yPos = checkPageBreak(yPos, 130);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('User Stories Analysis', 10, yPos);
            yPos += 15;

            // User Stories Table
            const total = currentReport.totalUserStories || 0;
            const userStoriesData = [
                ['Total User Stories', total, '100%'],
                ['Passed', currentReport.passedUserStories || 0, `${total ? Math.round(((currentReport.passedUserStories || 0) / total) * 100) : 0}%`],
                ['Passed with Issues', currentReport.passedWithIssuesUserStories || 0, `${total ? Math.round(((currentReport.passedWithIssuesUserStories || 0) / total) * 100) : 0}%`],
                ['Failed', currentReport.failedUserStories || 0, `${total ? Math.round(((currentReport.failedUserStories || 0) / total) * 100) : 0}%`],
                ['Blocked', currentReport.blockedUserStories || 0, `${total ? Math.round(((currentReport.blockedUserStories || 0) / total) * 100) : 0}%`],
                ['Cancelled', currentReport.cancelledUserStories || 0, `${total ? Math.round(((currentReport.cancelledUserStories || 0) / total) * 100) : 0}%`],
                ['Deferred', currentReport.deferredUserStories || 0, `${total ? Math.round(((currentReport.deferredUserStories || 0) / total) * 100) : 0}%`],
                ['Not Testable', currentReport.notTestableUserStories || 0, `${total ? Math.round(((currentReport.notTestableUserStories || 0) / total) * 100) : 0}%`]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Status', 'Count', 'Percentage']],
                body: userStoriesData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
            });
            yPos = doc.lastAutoTable.finalY + 10;

            // Add User Stories Chart
            yPos = await addChartToPDF('userStoriesViewChart', yPos, 'User Stories Distribution Chart');

            // Test Cases Analysis with Chart
            doc.addPage();
            yPos = 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Test Cases Analysis', 10, yPos);
            yPos += 15;

            const testCasesTotal = currentReport.totalTestCases || 0;
            const testCasesData = [
                ['Total Test Cases', testCasesTotal, '100%'],
                ['Passed', currentReport.passedTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.passedTestCases || 0) / testCasesTotal) * 100) : 0}%`],
                ['Passed with Issues', currentReport.passedWithIssuesTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.passedWithIssuesTestCases || 0) / testCasesTotal) * 100) : 0}%`],
                ['Failed', currentReport.failedTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.failedTestCases || 0) / testCasesTotal) * 100) : 0}%`],
                ['Blocked', currentReport.blockedTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.blockedTestCases || 0) / testCasesTotal) * 100) : 0}%`],
                ['Cancelled', currentReport.cancelledTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.cancelledTestCases || 0) / testCasesTotal) * 100) : 0}%`],
                ['Deferred', currentReport.deferredTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.deferredTestCases || 0) / testCasesTotal) * 100) : 0}%`],
                ['Not Testable', currentReport.notTestableTestCases || 0, `${testCasesTotal ? Math.round(((currentReport.notTestableTestCases || 0) / testCasesTotal) * 100) : 0}%`]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Status', 'Count', 'Percentage']],
                body: testCasesData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
            });
            yPos = doc.lastAutoTable.finalY + 10;

            // Add Test Cases Chart
            yPos = await addChartToPDF('testCasesViewChart', yPos, 'Test Cases Distribution Chart');

            doc.addPage();
            yPos = 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Issues by Priority', 10, yPos);
            yPos += 15;

            const issuesTotal = currentReport.totalIssues || 0;
            const issuesPriorityData = [
                ['Total Issues', issuesTotal, '100%'],
                ['Critical', currentReport.criticalIssues || 0, `${issuesTotal ? Math.round(((currentReport.criticalIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['High', currentReport.highIssues || 0, `${issuesTotal ? Math.round(((currentReport.highIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['Medium', currentReport.mediumIssues || 0, `${issuesTotal ? Math.round(((currentReport.mediumIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['Low', currentReport.lowIssues || 0, `${issuesTotal ? Math.round(((currentReport.lowIssues || 0) / issuesTotal) * 100) : 0}%`]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Priority', 'Count', 'Percentage']],
                body: issuesPriorityData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
            });
            yPos = doc.lastAutoTable.finalY + 10;

            yPos = await addChartToPDF('issuesPriorityViewChart', yPos, 'Issues by Priority Chart', 180, 80);

            doc.addPage();
            yPos = 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Issues by Status', 10, yPos);
            yPos += 15;

            const issuesStatusData = [
                ['New', currentReport.newIssues || 0, `${issuesTotal ? Math.round(((currentReport.newIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['Fixed', currentReport.fixedIssues || 0, `${issuesTotal ? Math.round(((currentReport.fixedIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['Not Fixed', currentReport.notFixedIssues || 0, `${issuesTotal ? Math.round(((currentReport.notFixedIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['Re-opened', currentReport.reopenedIssues || 0, `${issuesTotal ? Math.round(((currentReport.reopenedIssues || 0) / issuesTotal) * 100) : 0}%`],
                ['Deferred', currentReport.deferredIssues || 0, `${issuesTotal ? Math.round(((currentReport.deferredIssues || 0) / issuesTotal) * 100) : 0}%`]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Status', 'Count', 'Percentage']],
                body: issuesStatusData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
            });
            yPos = doc.lastAutoTable.finalY + 10;

            yPos = await addChartToPDF('issuesStatusViewChart', yPos, 'Issues by Status Chart', 180, 80);

            // Enhancements Analysis with Chart
            yPos = checkPageBreak(yPos, 130);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Enhancements Analysis', 10, yPos);
            yPos += 15;

            const enhancementsTotal = currentReport.totalEnhancements || 0;
            const enhancementsData = [
                ['Total Enhancements', enhancementsTotal, '100%'],
                ['New', currentReport.newEnhancements || 0, `${enhancementsTotal ? Math.round(((currentReport.newEnhancements || 0) / enhancementsTotal) * 100) : 0}%`],
                ['Implemented', currentReport.implementedEnhancements || 0, `${enhancementsTotal ? Math.round(((currentReport.implementedEnhancements || 0) / enhancementsTotal) * 100) : 0}%`],
                ['Exists', currentReport.existsEnhancements || 0, `${enhancementsTotal ? Math.round(((currentReport.existsEnhancements || 0) / enhancementsTotal) * 100) : 0}%`]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Status', 'Count', 'Percentage']],
                body: enhancementsData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
            });
            yPos = doc.lastAutoTable.finalY + 10;

            // Add Enhancements Chart
            yPos = await addChartToPDF('enhancementsViewChart', yPos, 'Enhancements Distribution Chart');

            // Additional Information
            if ((currentReport.requestData && currentReport.requestData.length > 0) ||
                (currentReport.buildData && currentReport.buildData.length > 0) ||
                (currentReport.testerData && currentReport.testerData.length > 0)) {
                
                doc.addPage();
                yPos = 20;
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Additional Information', 10, yPos);
                yPos += 15;

                // Requests
                if (currentReport.requestData && currentReport.requestData.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Request Information', 10, yPos);
                    yPos += 8;

                    const requestsData = currentReport.requestData.map(req => [req.id, req.url]);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Request ID', 'URL']],
                        body: requestsData,
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                // Builds
                if (currentReport.buildData && currentReport.buildData.length > 0) {
                    yPos = checkPageBreak(yPos, 40);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Build Information', 10, yPos);
                    yPos += 8;

                    const buildsData = currentReport.buildData.map(build => [build.requestId, build.environment, build.cycles]);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Request ID', 'Environment', 'Cycles']],
                        body: buildsData,
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                // Testers
                if (currentReport.testerData && currentReport.testerData.length > 0) {
                    yPos = checkPageBreak(yPos, 40);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Testers', 10, yPos);
                    yPos += 8;

                    const testersData = currentReport.testerData.map(tester => [tester.name]);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Tester Name']],
                        body: testersData,
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [59, 130, 246], textColor: 255 } // Using primary color
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }
            }


            // QA Notes
            if (currentReport.qaNotesText) {
                yPos = checkPageBreak(yPos, 40);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('QA Notes', 10, yPos);
                yPos += 15;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const notesText = doc.splitTextToSize(currentReport.qaNotesText, 190);
                doc.text(notesText, 10, yPos);
            }

            // Save the PDF
            doc.save(`QA_Report_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}_Complete.pdf`);
        }

        function exportCurrentReportAsExcel() {
            if (!currentReport) {
                showCustomMessageBox('Report data not loaded yet.');
                return;
            }
            
            // Use the same comprehensive Excel export as the main function
            const workbook = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ["Field", "Value"],
                ["Portfolio Name", currentReport.portfolioName || 'N/A'],
                ["Project Name", currentReport.projectName || 'N/A'],
                ["Sprint Number", currentReport.sprintNumber || 'N/A'],
                ["Report Version", currentReport.reportVersion || 'N/A'],
                ["Cycle Number", currentReport.cycleNumber || 'N/A'],
                ["Report Date", formatDate(currentReport.reportDate)],
                ["Testing Status", getStatusText(currentReport.testingStatus)],
                ["Test Summary", currentReport.testSummary || 'N/A'],
                ["", ""],
                ["METRICS", ""],
                ["Total User Stories", currentReport.totalUserStories || 0],
                ["Total Test Cases", currentReport.totalTestCases || 0],
                ["Total Issues", currentReport.totalIssues || 0],
                ["Total Enhancements", currentReport.totalEnhancements || 0],
                ["QA Notes", currentReport.qaNotesText || 'N/A']
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, wsSummary, "Summary");

            // User Stories Sheet
            const userStoriesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.passedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.passedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Passed with Issues", currentReport.passedWithIssuesUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.passedWithIssuesUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Failed", currentReport.failedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.failedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Blocked", currentReport.blockedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.blockedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Cancelled", currentReport.cancelledUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.cancelledUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Deferred", currentReport.deferredUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.deferredUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Not Testable", currentReport.notTestableUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.notTestableUserStories || 0) / currentReport.totalUserStories) * 100) : 0]
            ];
            const wsUserStories = XLSX.utils.aoa_to_sheet(userStoriesData);
            XLSX.utils.book_append_sheet(workbook, wsUserStories, "User Stories");

            // Test Cases Sheet
            const testCasesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.passedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.passedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Passed with Issues", currentReport.passedWithIssuesTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.passedWithIssuesTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Failed", currentReport.failedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.failedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Blocked", currentReport.blockedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.blockedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Cancelled", currentReport.cancelledTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.cancelledTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Deferred", currentReport.deferredTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.deferredTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Not Testable", currentReport.notTestableTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.notTestableTestCases || 0) / currentReport.totalTestCases) * 100) : 0]
            ];
            const wsTestCases = XLSX.utils.aoa_to_sheet(testCasesData);
            XLSX.utils.book_append_sheet(workbook, wsTestCases, "Test Cases");

            // Issues Sheet
            const issuesData = [
                ["Priority/Status", "Count", "Percentage"],
                ["", "", ""],
                ["PRIORITY BREAKDOWN", "", ""],
                ["Critical", currentReport.criticalIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.criticalIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["High", currentReport.highIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.highIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Medium", currentReport.mediumIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.mediumIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Low", currentReport.lowIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.lowIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["", "", ""],
                ["STATUS BREAKDOWN", "", ""],
                ["New", currentReport.newIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.newIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Fixed", currentReport.fixedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.fixedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Not Fixed", currentReport.notFixedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.notFixedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Re-opened", currentReport.reopenedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.reopenedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Deferred", currentReport.deferredIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.deferredIssues || 0) / currentReport.totalIssues) * 100) : 0]
            ];
            const wsIssues = XLSX.utils.aoa_to_sheet(issuesData);
            XLSX.utils.book_append_sheet(workbook, wsIssues, "Issues");

            // Enhancements Sheet
            const enhancementsData = [
                ["Status", "Count", "Percentage"],
                ["New", currentReport.newEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.newEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0],
                ["Implemented", currentReport.implementedEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.implementedEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0],
                ["Exists", currentReport.existsEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.existsEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0]
            ];
            const wsEnhancements = XLSX.utils.aoa_to_sheet(enhancementsData);
            XLSX.utils.book_append_sheet(workbook, wsEnhancements, "Enhancements");

            // Add all the additional sheets like in the main function
            if (currentReport.evaluationData && Object.keys(currentReport.evaluationData).length > 0) {
                const evaluationHeaders = ["Evaluation Criteria", "Score", "Weight", "Weighted Score"];
                const evaluationSheetData = [];
                
                for (const [key, value] of Object.entries(currentReport.evaluationData)) {
                    if (key.includes('_score')) {
                        const criteriaName = key.replace('_score', '').replace(/_/g, ' ').toUpperCase();
                        const weightKey = key.replace('_score', '_weight');
                        const weight = currentReport.evaluationData[weightKey] || 1;
                        const weightedScore = (value || 0) * weight;
                        evaluationSheetData.push([criteriaName, value || 0, weight, weightedScore]);
                    }
                }
                
                if (evaluationSheetData.length > 0) {
                    evaluationSheetData.unshift(["", "", "", ""]);
                    evaluationSheetData.unshift(["TOTAL EVALUATION SCORE", "", "", currentReport.evaluationTotalScore || 0]);
                    const wsEvaluation = XLSX.utils.aoa_to_sheet([evaluationHeaders, ...evaluationSheetData]);
                    XLSX.utils.book_append_sheet(workbook, wsEvaluation, "Evaluation");
                }
            }

            // Dynamic Data Sheets
            if (currentReport.requestData && currentReport.requestData.length > 0) {
                const requestHeaders = ["Request ID", "URL"];
                const requestsSheetData = currentReport.requestData.map(req => [req.id, req.url]);
                const wsRequests = XLSX.utils.aoa_to_sheet([requestHeaders, ...requestsSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsRequests, "Requests");
            }

            if (currentReport.buildData && currentReport.buildData.length > 0) {
                const buildHeaders = ["Request ID", "URL", "Environment", "Cycles"];
                const buildsSheetData = currentReport.buildData.map(build => [build.requestId, build.requestUrl, build.environment, build.cycles]);
                const wsBuilds = XLSX.utils.aoa_to_sheet([buildHeaders, ...buildsSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsBuilds, "Builds");
            }

            if (currentReport.testerData && currentReport.testerData.length > 0) {
                const testerHeaders = ["Tester Name"];
                const testersSheetData = currentReport.testerData.map(tester => [tester.name]);
                const wsTesters = XLSX.utils.aoa_to_sheet([testerHeaders, ...testersSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsTesters, "Testers");
            }

            XLSX.writeFile(workbook, `QA_Report_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}_Complete.xlsx`);
        }
        // Custom Message Box (instead of alert)
        function showCustomMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--surface);
                color: var(--text-primary);
                padding: 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-heavy);
                z-index: 9999;
                text-align: center;
                max-width: 300px;
                border: 1px solid var(--border);
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button onclick="this.parentNode.remove()" style="
                    background: var(--primary);
                    color: var(--text-primary);
                    border: none;
                    padding: 8px 15px;
                    border-radius: var(--border-radius);
                    margin-top: 15px;
                    cursor: pointer;
                    transition: var(--transition);
                ">OK</button>
            `;
            document.body.appendChild(messageBox);
        }
    </script>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">Made by <span class="highlight">Haitham Al-Mughrabi</span>. All rights reserved © 2024</p>
        </div>
    </footer>
</body>
</html>