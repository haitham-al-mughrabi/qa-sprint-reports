<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Report View</title>
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="preload" as="style" onload="this.rel='stylesheet'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Main styles -->
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/unified-nav.css">
    <link rel="stylesheet" href="/static/view_report.css">

    <!-- Theme manager (loads early) -->
    <script src="/static/theme-manager.js"></script>

    <!-- External libraries (defer non-critical) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

    <!-- Load non-critical CSS asynchronously -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"></noscript>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/dashboard" class="nav-brand">
                <i class="fas fa-chart-line"></i>
                <span>QA Reports</span>
            </a>
            
            <div class="nav-menu">
                <a href="/dashboard" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="/reports" class="nav-link active">
                    <i class="fas fa-file-alt"></i>
                    <span class="nav-text">Reports</span>
                </a>
                <a href="/create-report" class="nav-link">
                    <i class="fas fa-plus"></i>
                    <span class="nav-text">Create Report</span>
                </a>
                <a href="/manage" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Manage Data</span>
                </a>
                <a href="/project-statistics" class="nav-link">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-text">Statistics</span>
                </a>
                <a href="/profile" class="nav-link">
                    <i class="fas fa-user"></i>
                    <span class="nav-text">Profile</span>
                </a>
                
                <div class="nav-controls">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-sun" id="theme-icon"></i>
                        <span id="theme-text">Light</span>
                    </button>
                    
                    <div class="nav-dropdown">
                        <button class="nav-dropdown-btn">
                            <i class="fas fa-user-circle"></i>
                            <span class="user-name" id="userDisplayName">User</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="nav-dropdown-content">
                            <a href="/profile">
                                <i class="fas fa-user"></i>
                                Profile
                            </a>
                            <div id="adminLinks" style="display: none;">
                                <a href="/user-management">
                                    <i class="fas fa-users-cog"></i>
                                    User Management
                                </a>
                            </div>
                            <button onclick="logout()" class="nav-dropdown-item">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="dashboard-container">
            <div class="page-header centered">
                <div class="header-content">
                    <h1 id="reportTitle">Sprint Testing Report</h1>
                    <p id="reportSubtitle">Loading report details...</p>
                </div>
            </div>

            <!-- Action Buttons Card -->
            <div class="action-buttons-card">
                <div class="header-actions">
                    <div class="action-group">
                        <button class="action-btn btn-back" onclick="window.location.href='/reports'">
                            <i class="fas fa-arrow-left"></i> Back to Reports
                        </button>
                        <button class="action-btn btn-edit" onclick="editCurrentReport()" id="editReportBtn">
                            <i class="fas fa-edit"></i> Edit Report
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteCurrentReport()" id="deleteReportBtn">
                            <i class="fas fa-trash-alt"></i> Delete Report
                        </button>
                    </div>
                    <div class="export-group">
                        <button class="action-btn btn-export-pdf" onclick="exportCurrentReportAsPdf()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="action-btn btn-export-excel" onclick="exportCurrentReportAsExcel()">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button class="action-btn btn-export-styled-pdf" onclick="exportStyledReportAsPdf()">
                            <i class="fas fa-file-pdf"></i> Styled PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingSection" class="empty-state loading">
            <div class="spinner"></div>
            <h3>Loading Report Data...</h3>
            <p>Please wait while we fetch your report.</p>
        </div>

        <div class="dashboard-container" id="reportContent" style="display: none;">
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-info-circle"></i> General Information</h2>
                <div class="info-grid" id="coverInfo">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Test Summary & Status</h2>
                <div class="info-grid" id="testSummaryContent">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Testing Metrics Overview</h2>
                <div class="info-grid" id="metricsOverview">
                    </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-user-check"></i> User Stories Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">User Stories Summary</h3>
                        <table class="data-table" id="userStoriesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">User Stories Distribution</h3>
                        <div class="chart-container">
                            <canvas id="userStoriesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-flask"></i> Test Cases Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Cases Summary</h3>
                        <table class="data-table" id="testCasesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Cases Distribution</h3>
                        <div class="chart-container">
                            <canvas id="testCasesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> Issues by Priority</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Priority Breakdown</h3>
                        <table class="data-table" id="issuesPriorityViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Priority Chart</h3>
                        <div class="chart-container">
                            <canvas id="issuesPriorityViewChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-tasks"></i> Issues by Status</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Status Breakdown</h3>
                        <table class="data-table" id="issuesStatusViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Issues by Status Chart</h3>
                        <div class="chart-container">
                            <canvas id="issuesStatusViewChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-magic"></i> Enhancements Analysis</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Enhancements Summary</h3>
                        <table class="data-table" id="enhancementsViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Enhancements Distribution</h3>
                        <div class="chart-container">
                            <canvas id="enhancementsViewChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-robot"></i> Automation Regression</h2>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Automation Test Cases Summary</h3>
                        <table class="data-table" id="automationTestCasesViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Automation Test Cases Distribution</h3>
                        <div class="chart-container">
                            <canvas id="automationTestCasesViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Stability Summary</h3>
                        <table class="data-table" id="automationStabilityViewTable">
                            </table>
                    </div>
                    <div class="chart-section card">
                        <h3 class="chart-title">Test Stability Distribution</h3>
                        <div class="chart-container">
                            <canvas id="automationStabilityViewChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section" id="additionalInfoSection">
                <h2 class="section-title"><i class="fas fa-info"></i> Additional Information</h2>
                </div>

            <div class="dashboard-section" id="qaNotesSection">
                <h2 class="section-title"><i class="fas fa-sticky-note"></i> QA Notes</h2>
                <div class="info-item">
                    <div class="info-label">Additional Notes</div>
                    <div class="info-value" id="qaNotesContent">
                        <!-- QA Notes content will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Link to the external JavaScript files -->
    <script src="/static/enhanced_script.js" defer></script>
    <script>
        let currentReport = null;
        let viewCharts = {};

        // Toast notification functions
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
                <div class="toast-message">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto-hide toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function showSuccessToast(message) {
            showToast(message, 'success');
        }

        function showErrorToast(message) {
            showToast(message, 'error');
        }

        function showWarningToast(message) {
            showToast(message, 'warning');
        }

        function showInfoToast(message) {
            showToast(message, 'info');
        }

        // Get report ID from URL
        const reportId = window.location.pathname.split('/').pop();
        console.log('Attempting to load report ID:', reportId); // Log the ID being used

        // Load report data when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Load user info first
            await loadUserInfo();
            
            // Initialize theme first
            if (window.themeManager) {
                window.themeManager.init();
            }
            
            // Set active class for navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === window.location.pathname) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            await loadReportData(reportId);
        });

        async function loadReportData(id) {
            try {
                // Ensure the URL is correctly formed and accessible
                const apiUrl = `/api/reports/${id}`;
                console.log('Fetching report from:', apiUrl); // Log the full API URL

                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    // Log detailed error information from the server response
                    const errorText = await response.text(); // Get response body as text
                    console.error(`HTTP error! Status: ${response.status}, Status Text: ${response.statusText}, Response Body: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                currentReport = await response.json();
                console.log('Report data loaded successfully:', currentReport); // Log the loaded data
                
                renderReportView(currentReport);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('reportContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('loadingSection').innerHTML = `
                    <div class="empty-state">
                        <span class="icon">⚠️</span>
                        <h3>Error Loading Report</h3>
                        <p>Failed to load report data. Please check the console for more details.</p>
                        <a href="/" class="action-btn" style="margin-top: 1rem;">← Back to Dashboard</a>
                    </div>
                `;
            }
        }

        function renderReportView(report) {
            // Determine current theme
            const isLightMode = document.documentElement.getAttribute('data-theme') === 'light';

            // Update header
            document.getElementById('reportTitle').textContent = `${report.portfolioName} - Sprint ${report.sprintNumber}`;
            document.getElementById('reportSubtitle').textContent = `${report.projectName} | Version ${report.reportVersion} | ${formatDate(report.reportDate)}`;

            // Render cover information
            renderCoverInfo(report);
            
            // Render test summary
            renderTestSummary(report);
            
            // Render metrics overview
            renderMetricsOverview(report);
            
            // Render charts and tables
            renderUserStoriesView(report, isLightMode);
            renderTestCasesView(report, isLightMode);
            renderIssuesView(report, isLightMode); // This function now handles both priority and status
            renderEnhancementsView(report, isLightMode);
            renderAutomationRegressionView(report, isLightMode);
            
            // Render additional sections
            renderAdditionalInfo(report);
            renderQANotes(report);
        }

        function renderCoverInfo(report) {
            const coverInfo = document.getElementById('coverInfo');
            coverInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Portfolio Name</div>
                    <div class="info-value">${report.portfolioName || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Project Name</div>
                    <div class="info-value">${report.projectName || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Sprint Number</div>
                    <div class="info-value">#${report.sprintNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Version</div>
                    <div class="info-value">v${report.reportVersion || '1.0'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Release Number</div>
                    <div class="info-value">${report.releaseNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cycle Number</div>
                    <div class="info-value">${report.cycleNumber || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Report Date</div>
                    <div class="info-value">${formatDate(report.reportDate)}</div>
                </div>
            `;
        }

        function renderTestSummary(report) {
            const testSummaryContent = document.getElementById('testSummaryContent');
            testSummaryContent.innerHTML = `
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Testing Status</div>
                    <div class="info-value">
                        <span class="status-badge status-${getStatusClass(report.testingStatus)}">${getStatusText(report.testingStatus)}</span>
                    </div>
                </div>
                <div class="info-item" style="grid-column: 1 / -1;">
                    <div class="info-label">Test Summary</div>
                    <div class="info-value">${report.testSummary || 'No summary provided'}</div>
                </div>
            `;
        }

        function renderMetricsOverview(report) {
            const metricsOverview = document.getElementById('metricsOverview');
            metricsOverview.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Total User Stories</div>
                    <div class="info-value metric-highlight">${report.totalUserStories || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Test Cases</div>
                    <div class="info-value metric-highlight">${report.totalTestCases || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Issues</div>
                    <div class="info-value metric-highlight">${report.totalIssues || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Enhancements</div>
                    <div class="info-value metric-highlight">${report.totalEnhancements || 0}</div>
                </div>
            `;
        }

        function renderUserStoriesView(report, isLightMode) {
            const table = document.getElementById('userStoriesViewTable');
            const total = report.totalUserStories || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total User Stories</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.passedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Passed with Issues</td>
                        <td>${report.passedWithIssuesUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedWithIssuesUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.failedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.failedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Blocked</td>
                        <td>${report.blockedUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.blockedUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Cancelled</td>
                        <td>${report.cancelledUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.cancelledUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Testable</td>
                        <td>${report.notTestableUserStories || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notTestableUserStories || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('userStoriesViewChart').getContext('2d');
            if (viewCharts.userStories) viewCharts.userStories.destroy();
            
            viewCharts.userStories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedUserStories || 0,
                            report.passedWithIssuesUserStories || 0,
                            report.failedUserStories || 0,
                            report.blockedUserStories || 0,
                            report.cancelledUserStories || 0,
                            report.deferredUserStories || 0,
                            report.notTestableUserStories || 0
                        ],
                        backgroundColor: [
                            '#4CAF50', // Green - Passed
                            '#FFC107', // Amber - Passed with Issues
                            '#F44336', // Red - Failed
                            '#9E9E9E', // Grey - Blocked
                            '#2196F3', // Blue - Cancelled
                            '#673AB7', // Deep Purple - Deferred
                            '#00BCD4'  // Cyan - Not Testable
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderTestCasesView(report, isLightMode) {
            const table = document.getElementById('testCasesViewTable');
            const total = report.totalTestCases || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Test Cases</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.passedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Passed with Issues</td>
                        <td>${report.passedWithIssuesTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.passedWithIssuesTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.failedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.failedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Blocked</td>
                        <td>${report.blockedTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.blockedTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Cancelled</td>
                        <td>${report.cancelledTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.cancelledTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Testable</td>
                        <td>${report.notTestableTestCases || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notTestableTestCases || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('testCasesViewChart').getContext('2d');
            if (viewCharts.testCases) viewCharts.testCases.destroy();
            
            viewCharts.testCases = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedTestCases || 0,
                            report.passedWithIssuesTestCases || 0,
                            report.failedTestCases || 0,
                            report.blockedTestCases || 0,
                            report.cancelledTestCases || 0,
                            report.deferredTestCases || 0,
                            report.notTestableTestCases || 0
                        ],
                        backgroundColor: [
                            '#8BC34A', // Light Green - Passed
                            '#FFEB3B', // Yellow - Passed with Issues
                            '#E91E63', // Pink - Failed
                            '#607D8B', // Blue Grey - Blocked
                            '#9C27B0', // Purple - Cancelled
                            '#FF5722', // Deep Orange - Deferred
                            '#795548'  // Brown - Not Testable
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderIssuesView(report, isLightMode) {
            const priorityTable = document.getElementById('issuesPriorityViewTable');
            const statusTable = document.getElementById('issuesStatusViewTable');
            const total = report.totalIssues || 0;
            
            // Priority table
            priorityTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Issues</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Critical</td>
                        <td>${report.criticalIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.criticalIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>High</td>
                        <td>${report.highIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.highIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Medium</td>
                        <td>${report.mediumIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.mediumIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Low</td>
                        <td>${report.lowIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.lowIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Status table
            statusTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>New</td>
                        <td>${report.newIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.newIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Fixed</td>
                        <td>${report.fixedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.fixedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Not Fixed</td>
                        <td>${report.notFixedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.notFixedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Re-opened</td>
                        <td>${report.reopenedIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.reopenedIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Deferred</td>
                        <td>${report.deferredIssues || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.deferredIssues || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Priority chart with more vibrant colors
            const priorityCtx = document.getElementById('issuesPriorityViewChart').getContext('2d');
            if (viewCharts.issuesPriority) viewCharts.issuesPriority.destroy();
            
            viewCharts.issuesPriority = new Chart(priorityCtx, {
                type: 'doughnut', // Changed to doughnut for consistency with other charts
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [
                            report.criticalIssues || 0,
                            report.highIssues || 0,
                            report.mediumIssues || 0,
                            report.lowIssues || 0
                        ],
                        backgroundColor: [
                            '#F44336', // Red - Critical
                            '#FF9800', // Orange - High
                            '#FFC107', // Amber - Medium
                            '#4CAF50'  // Green - Low
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });

            // Status chart with more vibrant colors
            const statusCtx = document.getElementById('issuesStatusViewChart').getContext('2d');
            if (viewCharts.issuesStatus) viewCharts.issuesStatus.destroy();
            
            viewCharts.issuesStatus = new Chart(statusCtx, {
                type: 'doughnut', // Changed to doughnut for consistency with other charts
                data: {
                    labels: ['New', 'Fixed', 'Not Fixed', 'Re-opened', 'Deferred'],
                    datasets: [{
                        data: [
                            report.newIssues || 0,
                            report.fixedIssues || 0,
                            report.notFixedIssues || 0,
                            report.reopenedIssues || 0,
                            report.deferredIssues || 0
                        ],
                        backgroundColor: [
                            '#2196F3', // Blue - New
                            '#4CAF50', // Green - Fixed
                            '#E91E63', // Pink - Not Fixed
                            '#FF5722', // Deep Orange - Re-opened
                            '#673AB7'  // Deep Purple - Deferred
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderEnhancementsView(report, isLightMode) {
            const table = document.getElementById('enhancementsViewTable');
            const total = report.totalEnhancements || 0;
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Enhancements</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>New</td>
                        <td>${report.newEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.newEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Implemented</td>
                        <td>${report.implementedEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.implementedEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>Exists</td>
                        <td>${report.existsEnhancements || 0}</td>
                        <td class="percentage-cell">${total ? Math.round(((report.existsEnhancements || 0) / total) * 100) : 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create chart with more vibrant colors
            const ctx = document.getElementById('enhancementsViewChart').getContext('2d');
            if (viewCharts.enhancements) viewCharts.enhancements.destroy();
            
            viewCharts.enhancements = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Implemented', 'Exists'],
                    datasets: [{
                        data: [
                            report.newEnhancements || 0,
                            report.implementedEnhancements || 0,
                            report.existsEnhancements || 0
                        ],
                        backgroundColor: [
                            '#00BCD4', // Cyan - New
                            '#4CAF50', // Green - Implemented
                            '#9E9E9E'  // Grey - Exists
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderAutomationRegressionView(report, isLightMode) {
            // Render Test Cases Table
            const testCasesTable = document.getElementById('automationTestCasesViewTable');
            const total = report.automationTotalTestCases || 0;
            
            testCasesTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Test Cases</strong></td>
                        <td>${total}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Passed</td>
                        <td>${report.automationPassedTestCases || 0}</td>
                        <td class="percentage-cell">${report.automationPassedPercentage || 0}%</td>
                    </tr>
                    <tr>
                        <td>Failed</td>
                        <td>${report.automationFailedTestCases || 0}</td>
                        <td class="percentage-cell">${report.automationFailedPercentage || 0}%</td>
                    </tr>
                    <tr>
                        <td>Skipped</td>
                        <td>${report.automationSkippedTestCases || 0}</td>
                        <td class="percentage-cell">${report.automationSkippedPercentage || 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create Test Cases Chart
            const testCasesCtx = document.getElementById('automationTestCasesViewChart').getContext('2d');
            if (viewCharts.automationTestCases) viewCharts.automationTestCases.destroy();
            
            viewCharts.automationTestCases = new Chart(testCasesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Failed', 'Skipped'],
                    datasets: [{
                        data: [
                            report.automationPassedTestCases || 0,
                            report.automationFailedTestCases || 0,
                            report.automationSkippedTestCases || 0
                        ],
                        backgroundColor: [
                            '#28a745', // Green - Passed
                            '#dc3545', // Red - Failed
                            '#ffc107'  // Yellow - Skipped
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });

            // Render Stability Table
            const stabilityTable = document.getElementById('automationStabilityViewTable');
            const stabilityTotal = report.automationStabilityTotal || 0;
            
            stabilityTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Stability</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Total Tests</strong></td>
                        <td>${stabilityTotal}</td>
                        <td class="percentage-cell">100%</td>
                    </tr>
                    <tr>
                        <td>Stable</td>
                        <td>${report.automationStableTests || 0}</td>
                        <td class="percentage-cell">${report.automationStablePercentage || 0}%</td>
                    </tr>
                    <tr>
                        <td>Flaky</td>
                        <td>${report.automationFlakyTests || 0}</td>
                        <td class="percentage-cell">${report.automationFlakyPercentage || 0}%</td>
                    </tr>
                </tbody>
            `;

            // Create Stability Chart
            const stabilityCtx = document.getElementById('automationStabilityViewChart').getContext('2d');
            if (viewCharts.automationStability) viewCharts.automationStability.destroy();
            
            viewCharts.automationStability = new Chart(stabilityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Stable', 'Flaky'],
                    datasets: [{
                        data: [
                            report.automationStableTests || 0,
                            report.automationFlakyTests || 0
                        ],
                        backgroundColor: [
                            '#28a745', // Green - Stable
                            '#fd7e14'  // Orange - Flaky
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        // Function to update all charts when theme changes
        function updateChartsForTheme() {
            if (!currentReport) return;
            
            const isLightMode = document.documentElement.getAttribute('data-theme') === 'light';

            // Destroy existing charts
            Object.values(viewCharts).forEach(chart => {
                if (chart && chart.destroy) {
                    chart.destroy();
                }
            });
            
            // Clear the viewCharts object
            viewCharts = {};
            
            // Recreate only the charts (not tables) with new theme colors
            renderUserStoriesChart(currentReport, isLightMode);
            renderTestCasesChart(currentReport, isLightMode);
            renderIssuesPriorityChart(currentReport, isLightMode);
            renderIssuesStatusChart(currentReport, isLightMode);
            renderEnhancementsChart(currentReport, isLightMode);
            renderAutomationTestCasesChart(currentReport, isLightMode);
            renderAutomationStabilityChart(currentReport, isLightMode);
        }

        // Individual chart rendering functions for theme updates
        function renderUserStoriesChart(report, isLightMode) {
            const ctx = document.getElementById('userStoriesViewChart').getContext('2d');
            if (viewCharts.userStories) viewCharts.userStories.destroy();
            
            viewCharts.userStories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedUserStories || 0,
                            report.passedWithIssuesUserStories || 0,
                            report.failedUserStories || 0,
                            report.blockedUserStories || 0,
                            report.cancelledUserStories || 0,
                            report.deferredUserStories || 0,
                            report.notTestableUserStories || 0
                        ],
                        backgroundColor: [
                            '#4CAF50', '#FFC107', '#F44336', '#9E9E9E', 
                            '#2196F3', '#673AB7', '#00BCD4'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderTestCasesChart(report, isLightMode) {
            const ctx = document.getElementById('testCasesViewChart').getContext('2d');
            if (viewCharts.testCases) viewCharts.testCases.destroy();
            
            viewCharts.testCases = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Passed with Issues', 'Failed', 'Blocked', 'Cancelled', 'Deferred', 'Not Testable'],
                    datasets: [{
                        data: [
                            report.passedTestCases || 0,
                            report.passedWithIssuesTestCases || 0,
                            report.failedTestCases || 0,
                            report.blockedTestCases || 0,
                            report.cancelledTestCases || 0,
                            report.deferredTestCases || 0,
                            report.notTestableTestCases || 0
                        ],
                        backgroundColor: [
                            '#8BC34A', '#FFEB3B', '#E91E63', '#607D8B', 
                            '#9C27B0', '#FF5722', '#795548'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderIssuesPriorityChart(report, isLightMode) {
            const priorityCtx = document.getElementById('issuesPriorityViewChart').getContext('2d');
            if (viewCharts.issuesPriority) viewCharts.issuesPriority.destroy();
            
            viewCharts.issuesPriority = new Chart(priorityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [
                            report.criticalIssues || 0,
                            report.highIssues || 0,
                            report.mediumIssues || 0,
                            report.lowIssues || 0
                        ],
                        backgroundColor: [
                            '#F44336', '#FF9800', '#FFC107', '#4CAF50'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderIssuesStatusChart(report, isLightMode) {
            const statusCtx = document.getElementById('issuesStatusViewChart').getContext('2d');
            if (viewCharts.issuesStatus) viewCharts.issuesStatus.destroy();
            
            viewCharts.issuesStatus = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Fixed', 'Not Fixed', 'Re-opened', 'Deferred'],
                    datasets: [{
                        data: [
                            report.newIssues || 0,
                            report.fixedIssues || 0,
                            report.notFixedIssues || 0,
                            report.reopenedIssues || 0,
                            report.deferredIssues || 0
                        ],
                        backgroundColor: [
                            '#2196F3', '#4CAF50', '#E91E63', '#FF5722', '#673AB7'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderEnhancementsChart(report, isLightMode) {
            const ctx = document.getElementById('enhancementsViewChart').getContext('2d');
            if (viewCharts.enhancements) viewCharts.enhancements.destroy();
            
            viewCharts.enhancements = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Implemented', 'Exists'],
                    datasets: [{
                        data: [
                            report.newEnhancements || 0,
                            report.implementedEnhancements || 0,
                            report.existsEnhancements || 0
                        ],
                        backgroundColor: [
                            '#00BCD4', '#4CAF50', '#9E9E9E'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderAutomationTestCasesChart(report, isLightMode) {
            const ctx = document.getElementById('automationTestCasesViewChart').getContext('2d');
            if (viewCharts.automationTestCases) viewCharts.automationTestCases.destroy();
            
            viewCharts.automationTestCases = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Failed', 'Skipped'],
                    datasets: [{
                        data: [
                            report.automationPassedTestCases || 0,
                            report.automationFailedTestCases || 0,
                            report.automationSkippedTestCases || 0
                        ],
                        backgroundColor: [
                            '#28a745', '#dc3545', '#ffc107'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        function renderAutomationStabilityChart(report, isLightMode) {
            const ctx = document.getElementById('automationStabilityViewChart').getContext('2d');
            if (viewCharts.automationStability) viewCharts.automationStability.destroy();
            
            viewCharts.automationStability = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Stable', 'Flaky'],
                    datasets: [{
                        data: [
                            report.automationStableTests || 0,
                            report.automationFlakyTests || 0
                        ],
                        backgroundColor: [
                            '#28a745', '#fd7e14'
                        ],
                        borderWidth: 3,
                        borderColor: 'var(--surface)'
                    }]
                },
                options: getViewChartOptions(isLightMode)
            });
        }

        // Listen for theme changes - both mutation observer and custom event
        document.addEventListener('DOMContentLoaded', function() {
            // Watch for theme attribute changes (fallback)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        updateChartsForTheme();
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme']
            });
        });

        // Listen for custom theme change event (primary method)
        window.addEventListener('themeChanged', function(event) {
            updateChartsForTheme();
        });

        function renderAdditionalInfo(report) {
            const section = document.getElementById('additionalInfoSection');
            let content = '';

            // Requests
            if (report.requestData && report.requestData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">📋 Request Information</h3>
                    <div class="dynamic-list">
                        ${report.requestData.map(req => `
                            <div class="dynamic-item">
                                <strong>ID:</strong> ${req.id}<br>
                                <strong>URL:</strong> ${req.url}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Builds
            if (report.buildData && report.buildData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">🏗️ Build Information</h3>
                    <div class="dynamic-list">
                        ${report.buildData.map(build => `
                            <div class="dynamic-item">
                                <strong>Request ID:</strong> ${build.requestId}<br>
                                <strong>URL:</strong> ${build.requestUrl}<br>
                                <strong>Environment:</strong> ${build.environment}<br>
                                <strong>Cycles:</strong> ${build.cycles}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Testers
            if (report.testerData && report.testerData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">🧪 Tester Information</h3>
                    <div class="dynamic-list">
                        ${report.testerData.map(tester => {
                            const roles = [];
                            if (tester.is_automation_engineer) roles.push('Automation Engineer');
                            if (tester.is_manual_engineer) roles.push('Manual Engineer');
                            const roleText = roles.length > 0 ? `<br><strong>Roles:</strong> ${roles.join(', ')}` : '<br><em style="color: #6c757d;">No roles assigned</em>';
                            
                            return `
                            <div class="dynamic-item">
                                <strong>Tester:</strong> ${tester.name}
                                ${tester.email ? `<br><strong>Email:</strong> ${tester.email}` : ''}${roleText}
                            </div>`;
                        }).join('')}
                    </div>
                `;
            }

            // Team Members
            if (report.teamMemberData && report.teamMemberData.length > 0) {
                content += `
                    <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">👥 Team Members</h3>
                    <div class="dynamic-list">
                        ${report.teamMemberData.map(member => `
                            <div class="dynamic-item">
                                <strong>Member:</strong> ${member.name}
                                ${member.email ? `<br><strong>Email:</strong> ${member.email}` : ''}
                                ${member.role ? `<br><strong>Role:</strong> ${member.role}` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Custom Fields - REMOVED
            // if (report.customFields && Object.keys(report.customFields).length > 0) {
            //     content += `
            //         <h3 class="section-title" style="font-size: 1.25rem; margin-top: 1.5rem;">⚙️ Custom Fields</h3>
            //         <div class="dynamic-list">
            //             ${Object.entries(report.customFields).map(([key, value]) => `
            //                 <div class="dynamic-item">
            //                     <strong>${key}:</strong> ${value}
            //                 </div>
            //             `).join('')}
            //         </div>
            //     `;
            // }

            if (!content) {
                content = '<div class="empty-state"><h3>No Additional Information Provided</h3><p>This report does not contain any extra details.</p></div>';
            }

            section.innerHTML = `<h2 class="section-title">Additional Information</h2>${content}`;
        }

        function renderQANotes(report) {
            const qaNotesContent = document.getElementById('qaNotesContent');
            const qaNotesData = report.qaNotesData || [];

            let hasNotes = false;
            let notesHtml = '';

            // Check for array-based notes
            if (qaNotesData.length > 0) {
                qaNotesData.forEach(noteItem => {
                    if (noteItem.note && noteItem.note.trim()) {
                        notesHtml += `<div class="dynamic-item">${noteItem.note}</div>`;
                        hasNotes = true;
                    }
                });
            }

            if (hasNotes) {
                qaNotesContent.innerHTML = notesHtml;
            } else {
                qaNotesContent.innerHTML = `<div class="empty-state" style="border: none; padding: 0; background: none;">
                    <h3>No QA Notes</h3>
                    <p>No specific QA notes were provided for this report.</p>
                </div>`;
            }
            
        }

                function getViewChartOptions(isLightMode) {
            // Get current theme
            const isLightTheme = document.documentElement.getAttribute('data-theme') === 'light';
            const textColor = isLightTheme ? '#1e293b' : '#f1f5f9';
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            padding: 15, 
                            usePointStyle: true, 
                            font: {
                                size: 10,
                                family: 'Poppins'
                            },
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.parsed || 0;
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        },
                        titleColor: textColor,
                        bodyColor: textColor,
                        backgroundColor: isLightMode ? '#ffffff' : '#1e293b',
                        borderColor: isLightMode ? '#e2e8f0' : '#334155',
                        borderWidth: 1,
                        titleFont: {
                            family: 'Poppins'
                        },
                        bodyFont: {
                            family: 'Poppins'
                        }
                    }
                }
            };
        }

                function getBarChartOptions(yAxisLabel, isLightMode) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                        },
                        titleColor: '#f1f5f9',
                        bodyColor: '#f1f5f9',
                        backgroundColor: isLightMode ? '#ffffff' : '#1e293b',
                        borderColor: isLightMode ? '#e2e8f0' : '#334155',
                        borderWidth: 1,
                        titleFont: {
                            family: 'Poppins'
                        },
                        bodyFont: {
                            family: 'Poppins'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'var(--text-secondary)',
                            font: {
                                family: 'Poppins'
                            }
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.5)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'var(--text-secondary)',
                            font: {
                                family: 'Poppins'
                            }
                        },
                        grid: {
                            color: 'rgba(51, 65, 85, 0.5)'
                        },
                        title: {
                            display: true,
                            text: yAxisLabel,
                            color: 'var(--text-primary)',
                            font: {
                                family: 'Poppins'
                            }
                        }
                    }
                }
            };
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString.includes('-') && dateString.length === 10 ? 
                dateString.split('-').reverse().join('-') : dateString);
            return isNaN(date) ? 'Invalid Date' : date.toLocaleDateString('en-GB');
        }

        function getStatusClass(status) {
            const map = { 
                'passed': 'completed', 
                'passed-with-issues': 'in-progress',
                'failed': 'pending', // Consider a 'failed' specific class if needed
                'blocked': 'pending',
                'cancelled': 'pending',
                'deferred': 'pending',
                'not-testable': 'pending'
            };
            return map[status] || 'pending';
        }

        function getStatusText(status) {
            const map = { 
                'passed': 'Passed', 
                'passed-with-issues': 'Passed w/ Issues', 
                'failed': 'Failed', 
                'blocked': 'Blocked', 
                'cancelled': 'Cancelled', 
                'deferred': 'Deferred', 
                'not-testable': 'Not Testable' 
            };
            return map[status] || 'Pending';
        }

        function editCurrentReport() {
            if (!currentReport) {
                showCustomMessageBox('Report data not loaded yet.');
                return;
            }
            
            // Redirect to create report page with edit mode
            window.location.href = `/create-report?id=${currentReport.id}`;
        }

        function deleteCurrentReport() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }

            if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                fetch(`/api/reports/${currentReport.id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            showSuccessToast('Report deleted successfully!');
                            setTimeout(() => {
                                window.location.href = '/reports';
                            }, 1500);
                        } else {
                            showErrorToast('Failed to delete report.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting report:', error);
                        showErrorToast('An error occurred while deleting the report.');
                    });
            }
        }

        async function exportCurrentReportAsPdf() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }
            
            showInfoToast('Generating comprehensive PDF export...');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPos = margin;

            // Helper function to check if we need a new page
            const checkNewPage = (requiredSpace = 80) => {
                if (yPos + requiredSpace > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                    return true;
                }
                return false;
            };

            // Header
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('QA Testing Report', pageWidth / 2, yPos, { align: 'center' });
            yPos += 30;

            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text(`${currentReport.portfolioName} - Sprint ${currentReport.sprintNumber}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 18;
            doc.text(`${currentReport.projectName} | Version ${currentReport.reportVersion} | ${formatDate(currentReport.reportDate)}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 40; // Increased space after header

            // Helper function to add a section title
            const addSectionTitle = (title) => {
                checkNewPage(50); // Ensure space for title + some content
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(title, margin, yPos);
                yPos += 25; // Space after title
            };

            // 1. General Information
            addSectionTitle('General Information');

            const coverData = [
                ['Portfolio Name', currentReport.portfolioName || 'N/A'],
                ['Project Name', currentReport.projectName || 'N/A'],
                ['Sprint Number', `#${currentReport.sprintNumber || 'N/A'}`],
                ['Report Version', `v${currentReport.reportVersion || '1.0'}`],
                ['Release Number', currentReport.releaseNumber || 'N/A'],
                ['Cycle Number', currentReport.cycleNumber || 'N/A'],
                ['Report Date', formatDate(currentReport.reportDate)],
                ['Testing Status', getStatusText(currentReport.testingStatus)]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Field', 'Value']],
                body: coverData,
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' }, // Blue-ish header
                styles: { fontSize: 10, cellPadding: 4 },
                margin: { left: margin, right: margin }
            });
            yPos = doc.lastAutoTable.finalY + 30;

            // 2. Test Summary & Status
            addSectionTitle('Test Summary & Status');

            const testSummaryData = [
                ['Testing Status', getStatusText(currentReport.testingStatus)],
                ['Test Summary', currentReport.testSummary || 'No summary provided']
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Field', 'Value']],
                body: testSummaryData,
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 10, cellPadding: 4 },
                margin: { left: margin, right: margin },
                columnStyles: {
                    1: { cellWidth: 'auto', minCellWidth: 350 } // Auto-width for summary text, with a minimum
                }
            });
            yPos = doc.lastAutoTable.finalY + 30;

            // 3. Testing Metrics Overview
            addSectionTitle('Testing Metrics Overview');

            const metricsData = [
                ['Total User Stories', currentReport.totalUserStories || 0],
                ['Total Test Cases', currentReport.totalTestCases || 0],
                ['Total Issues', currentReport.totalIssues || 0],
                ['Total Enhancements', currentReport.totalEnhancements || 0]
            ];

            doc.autoTable({
                startY: yPos,
                head: [['Metric', 'Count']],
                body: metricsData,
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 10, cellPadding: 4 },
                margin: { left: margin, right: margin }
            });
            yPos = doc.lastAutoTable.finalY + 30;

            // 4. User Stories Analysis
            addSectionTitle('User Stories Analysis');

            const total = currentReport.totalUserStories || 0;
            const userStoriesData = [
                ['Status', 'Count', 'Percentage'],
                ['Total User Stories', total, '100%'],
                ['Passed', currentReport.passedUserStories || 0, total ? Math.round(((currentReport.passedUserStories || 0) / total) * 100) + '%' : '0%'],
                ['Passed with Issues', currentReport.passedWithIssuesUserStories || 0, total ? Math.round(((currentReport.passedWithIssuesUserStories || 0) / total) * 100) + '%' : '0%'],
                ['Failed', currentReport.failedUserStories || 0, total ? Math.round(((currentReport.failedUserStories || 0) / total) * 100) + '%' : '0%'],
                ['Blocked', currentReport.blockedUserStories || 0, total ? Math.round(((currentReport.blockedUserStories || 0) / total) * 100) + '%' : '0%'],
                ['Cancelled', currentReport.cancelledUserStories || 0, total ? Math.round(((currentReport.cancelledUserStories || 0) / total) * 100) + '%' : '0%'],
                ['Deferred', currentReport.deferredUserStories || 0, total ? Math.round(((currentReport.deferredUserStories || 0) / total) * 100) + '%' : '0%'],
                ['Not Testable', currentReport.notTestableUserStories || 0, total ? Math.round(((currentReport.notTestableUserStories || 0) / total) * 100) + '%' : '0%']
            ];

            // Create table and chart side by side - using web dimensions
            const tableStartY = yPos;
            const tableWidth = 260;
            const chartStartX = margin + tableWidth + 20;
            const chartHeight = 150; // Set to 150pt for square charts
            const chartWidth = 150;  // Set to 150pt for square charts

            doc.autoTable({
                startY: tableStartY,
                head: [userStoriesData[0]],
                body: userStoriesData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const userStoriesCanvas = document.getElementById('userStoriesViewChart');
            if (userStoriesCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4; // Higher resolution
                tempCanvas.width = userStoriesCanvas.width * scale;
                tempCanvas.height = userStoriesCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(userStoriesCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, tableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, tableStartY + chartHeight) + 30;

            // 5. Test Cases Analysis
            addSectionTitle('Test Cases Analysis');

            const totalTestCases = currentReport.totalTestCases || 0;
            const testCasesData = [
                ['Status', 'Count', 'Percentage'],
                ['Total Test Cases', totalTestCases, '100%'],
                ['Passed', currentReport.passedTestCases || 0, totalTestCases ? Math.round(((currentReport.passedTestCases || 0) / totalTestCases) * 100) + '%' : '0%'],
                ['Passed with Issues', currentReport.passedWithIssuesTestCases || 0, totalTestCases ? Math.round(((currentReport.passedWithIssuesTestCases || 0) / totalTestCases) * 100) + '%' : '0%'],
                ['Failed', currentReport.failedTestCases || 0, totalTestCases ? Math.round(((currentReport.failedTestCases || 0) / totalTestCases) * 100) + '%' : '0%'],
                ['Blocked', currentReport.blockedTestCases || 0, totalTestCases ? Math.round(((currentReport.blockedTestCases || 0) / totalTestCases) * 100) + '%' : '0%'],
                ['Cancelled', currentReport.cancelledTestCases || 0, totalTestCases ? Math.round(((currentReport.cancelledTestCases || 0) / totalTestCases) * 100) + '%' : '0%'],
                ['Deferred', currentReport.deferredTestCases || 0, totalTestCases ? Math.round(((currentReport.deferredTestCases || 0) / totalTestCases) * 100) + '%' : '0%'],
                ['Not Testable', currentReport.notTestableTestCases || 0, totalTestCases ? Math.round(((currentReport.notTestableTestCases || 0) / totalTestCases) * 100) + '%' : '0%']
            ];

            // Create table and chart side by side
            const testCasesTableStartY = yPos;

            doc.autoTable({
                startY: testCasesTableStartY,
                head: [testCasesData[0]],
                body: testCasesData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const testCasesCanvas = document.getElementById('testCasesViewChart');
            if (testCasesCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4;
                tempCanvas.width = testCasesCanvas.width * scale;
                tempCanvas.height = testCasesCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(testCasesCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, testCasesTableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, testCasesTableStartY + chartHeight) + 30;

            // 6. Issues by Priority
            addSectionTitle('Issues by Priority');

            const totalIssues = currentReport.totalIssues || 0;
            const issuesPriorityData = [
                ['Priority', 'Count', 'Percentage'],
                ['Total Issues', totalIssues, '100%'],
                ['Critical', currentReport.criticalIssues || 0, totalIssues ? Math.round(((currentReport.criticalIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['High', currentReport.highIssues || 0, totalIssues ? Math.round(((currentReport.highIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['Medium', currentReport.mediumIssues || 0, totalIssues ? Math.round(((currentReport.mediumIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['Low', currentReport.lowIssues || 0, totalIssues ? Math.round(((currentReport.lowIssues || 0) / totalIssues) * 100) + '%' : '0%']
            ];

            // Create table and chart side by side - Issues by Priority (high quality)
            const issuesPriorityTableStartY = yPos;

            doc.autoTable({
                startY: issuesPriorityTableStartY,
                head: [issuesPriorityData[0]],
                body: issuesPriorityData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const issuesPriorityCanvas = document.getElementById('issuesPriorityViewChart');
            if (issuesPriorityCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4;
                tempCanvas.width = issuesPriorityCanvas.width * scale;
                tempCanvas.height = issuesPriorityCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(issuesPriorityCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, issuesPriorityTableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, issuesPriorityTableStartY + chartHeight) + 30;

            // 7. Issues by Status
            addSectionTitle('Issues by Status');

            const issuesStatusData = [
                ['Status', 'Count', 'Percentage'],
                ['New', currentReport.newIssues || 0, totalIssues ? Math.round(((currentReport.newIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['Fixed', currentReport.fixedIssues || 0, totalIssues ? Math.round(((currentReport.fixedIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['Not Fixed', currentReport.notFixedIssues || 0, totalIssues ? Math.round(((currentReport.notFixedIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['Re-opened', currentReport.reopenedIssues || 0, totalIssues ? Math.round(((currentReport.reopenedIssues || 0) / totalIssues) * 100) + '%' : '0%'],
                ['Deferred', currentReport.deferredIssues || 0, totalIssues ? Math.round(((currentReport.deferredIssues || 0) / totalIssues) * 100) + '%' : '0%']
            ];

            // Create table and chart side by side - Issues by Status (high quality)
            const issuesStatusTableStartY = yPos;

            doc.autoTable({
                startY: issuesStatusTableStartY,
                head: [issuesStatusData[0]],
                body: issuesStatusData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const issuesStatusCanvas = document.getElementById('issuesStatusViewChart');
            if (issuesStatusCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4;
                tempCanvas.width = issuesStatusCanvas.width * scale;
                tempCanvas.height = issuesStatusCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(issuesStatusCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, issuesStatusTableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, issuesStatusTableStartY + chartHeight) + 30;

            // 8. Enhancements Analysis
            addSectionTitle('Enhancements Analysis');

            const totalEnhancements = currentReport.totalEnhancements || 0;
            const enhancementsData = [
                ['Status', 'Count', 'Percentage'],
                ['Total Enhancements', totalEnhancements, '100%'],
                ['New', currentReport.newEnhancements || 0, totalEnhancements ? Math.round(((currentReport.newEnhancements || 0) / totalEnhancements) * 100) + '%' : '0%'],
                ['Implemented', currentReport.implementedEnhancements || 0, totalEnhancements ? Math.round(((currentReport.implementedEnhancements || 0) / totalEnhancements) * 100) + '%' : '0%'],
                ['Exists', currentReport.existsEnhancements || 0, totalEnhancements ? Math.round(((currentReport.existsEnhancements || 0) / totalEnhancements) * 100) + '%' : '0%']
            ];

            // Create table and chart side by side - Enhancements Analysis (high quality)
            const enhancementsTableStartY = yPos;

            doc.autoTable({
                startY: enhancementsTableStartY,
                head: [enhancementsData[0]],
                body: enhancementsData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const enhancementsCanvas = document.getElementById('enhancementsViewChart');
            if (enhancementsCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4;
                tempCanvas.width = enhancementsCanvas.width * scale;
                tempCanvas.height = enhancementsCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(enhancementsCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, enhancementsTableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, enhancementsTableStartY + chartHeight) + 30;

            // 9. Automation Regression - Test Cases
            addSectionTitle('Automation Regression - Test Cases');

            const automationTotal = currentReport.automationTotalTestCases || 0;
            const automationTestCasesData = [
                ['Status', 'Count', 'Percentage'],
                ['Total Test Cases', automationTotal, '100%'],
                ['Passed', currentReport.automationPassedTestCases || 0, currentReport.automationPassedPercentage + '%' || '0%'],
                ['Failed', currentReport.automationFailedTestCases || 0, currentReport.automationFailedPercentage + '%' || '0%'],
                ['Skipped', currentReport.automationSkippedTestCases || 0, currentReport.automationSkippedPercentage + '%' || '0%']
            ];

            // Create table and chart side by side
            const automationTestCasesTableStartY = yPos;

            doc.autoTable({
                startY: automationTestCasesTableStartY,
                head: [automationTestCasesData[0]],
                body: automationTestCasesData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const automationTestCasesCanvas = document.getElementById('automationTestCasesViewChart');
            if (automationTestCasesCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4;
                tempCanvas.width = automationTestCasesCanvas.width * scale;
                tempCanvas.height = automationTestCasesCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(automationTestCasesCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, automationTestCasesTableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, automationTestCasesTableStartY + chartHeight) + 30;

            // 10. Automation Regression - Test Stability
            addSectionTitle('Automation Regression - Test Stability');

            const stabilityTotal = currentReport.automationStabilityTotal || 0;
            const automationStabilityData = [
                ['Stability', 'Count', 'Percentage'],
                ['Total Tests', stabilityTotal, '100%'],
                ['Stable', currentReport.automationStableTests || 0, currentReport.automationStablePercentage + '%' || '0%'],
                ['Flaky', currentReport.automationFlakyTests || 0, currentReport.automationFlakyPercentage + '%' || '0%']
            ];

            // Create table and chart side by side
            const automationStabilityTableStartY = yPos;

            doc.autoTable({
                startY: automationStabilityTableStartY,
                head: [automationStabilityData[0]],
                body: automationStabilityData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                margin: { left: margin, right: chartStartX },
                tableWidth: tableWidth,
                styles: { fontSize: 9, cellPadding: 3 }
            });

            // Add chart beside the table with high quality capture
            const automationStabilityCanvas = document.getElementById('automationStabilityViewChart');
            if (automationStabilityCanvas) {
                // Create a temporary canvas with higher resolution
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const scale = 4;
                tempCanvas.width = automationStabilityCanvas.width * scale;
                tempCanvas.height = automationStabilityCanvas.height * scale;
                tempCtx.scale(scale, scale);
                tempCtx.drawImage(automationStabilityCanvas, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                doc.addImage(imgData, 'PNG', chartStartX, automationStabilityTableStartY + 5, chartWidth, chartHeight, null, 'FAST');
            }

            yPos = Math.max(doc.lastAutoTable.finalY, automationStabilityTableStartY + chartHeight) + 30;

            // 11. Additional Information Sections
            if (currentReport.requestData && currentReport.requestData.length > 0) {
                addSectionTitle('Request Information');
            }
            if (currentReport.buildData && currentReport.buildData.length > 0) {
                addSectionTitle('Build Information');
            }

            if (currentReport.testerData && currentReport.testerData.length > 0) {
                addSectionTitle('Tester Information');

                const testerHeaders = ['Tester Name', 'Email', 'Roles'];
                const testerData = currentReport.testerData.map(tester => {
                    const roles = [];
                    if (tester.is_automation_engineer) roles.push('Automation Engineer');
                    if (tester.is_manual_engineer) roles.push('Manual Engineer');
                    const roleText = roles.length > 0 ? roles.join(', ') : 'No roles assigned';
                    return [tester.name, tester.email || '', roleText];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [testerHeaders],
                    body: testerData,
                    theme: 'grid',
                    headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 3 },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        2: { cellWidth: 'auto' } // Auto-width for roles
                    }
                });
                yPos = doc.lastAutoTable.finalY + 30;
            }

            if (currentReport.teamMemberData && currentReport.teamMemberData.length > 0) {
                addSectionTitle('Team Members');

                const teamHeaders = ['Team Member Name', 'Email', 'Role'];
                const teamData = currentReport.teamMemberData.map(member => [
                    member.name,
                    member.email || '',
                    member.role || ''
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [teamHeaders],
                    body: teamData,
                    theme: 'grid',
                    headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 3 },
                    margin: { left: margin, right: margin },
                    columnStyles: {
                        2: { cellWidth: 'auto' } // Auto-width for role
                    }
                });
                yPos = doc.lastAutoTable.finalY + 30;
            }

            // 12. QA Notes
            if (currentReport.qaNotesData && currentReport.qaNotesData.length > 0) {
                addSectionTitle('QA Notes');

                const qaNotesHeaders = ['Note'];
                const qaNotesDataForTable = currentReport.qaNotesData
                    .filter(noteItem => noteItem.note && noteItem.note.trim())
                    .map(noteItem => [noteItem.note]);

                if (qaNotesDataForTable.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [qaNotesHeaders],
                        body: qaNotesDataForTable,
                        theme: 'grid',
                        headStyles: { fillColor: [60, 141, 188], textColor: 255, fontStyle: 'bold' },
                        styles: { fontSize: 9, cellPadding: 3, cellWidth: 'auto' },
                        margin: { left: margin, right: margin }
                    });
                    yPos = doc.lastAutoTable.finalY + 30;
                }
            }

            // Charts are now placed beside their respective tables above

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
            }

            doc.save(`QA_Report_Complete_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}.pdf`);
            showSuccessToast('Comprehensive PDF export completed successfully!');
        }

        function exportCurrentReportAsExcel() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }
            
            showInfoToast('Generating Excel export...');
            
            // Use the same comprehensive Excel export as the main function
            const workbook = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ["Field", "Value"],
                ["Portfolio Name", currentReport.portfolioName || 'N/A'],
                ["Project Name", currentReport.projectName || 'N/A'],
                ["Sprint Number", currentReport.sprintNumber || 'N/A'],
                ["Report Version", currentReport.reportVersion || 'N/A'],
                ["Cycle Number", currentReport.cycleNumber || 'N/A'],
                ["Report Date", formatDate(currentReport.reportDate)],
                ["Testing Status", getStatusText(currentReport.testingStatus)],
                ["Test Summary", currentReport.testSummary || 'N/A'],
                ["", ""],
                ["METRICS", ""],
                ["Total User Stories", currentReport.totalUserStories || 0],
                ["Total Test Cases", currentReport.totalTestCases || 0],
                ["Total Issues", currentReport.totalIssues || 0],
                ["Total Enhancements", currentReport.totalEnhancements || 0],
                ["", ""],
                ["AUTOMATION REGRESSION", ""],
                ["Automation Total Test Cases", currentReport.automationTotalTestCases || 0],
                ["Automation Passed Test Cases", currentReport.automationPassedTestCases || 0],
                ["Automation Failed Test Cases", currentReport.automationFailedTestCases || 0],
                ["Automation Skipped Test Cases", currentReport.automationSkippedTestCases || 0],
                ["Automation Stable Tests", currentReport.automationStableTests || 0],
                ["Automation Flaky Tests", currentReport.automationFlakyTests || 0],
                ["QA Notes", currentReport.qaNotesData && currentReport.qaNotesData.length > 0 ? `${currentReport.qaNotesData.length} notes` : 'N/A']
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, wsSummary, "Summary");

            // User Stories Sheet
            const userStoriesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.passedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.passedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Passed with Issues", currentReport.passedWithIssuesUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.passedWithIssuesUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Failed", currentReport.failedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.failedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Blocked", currentReport.blockedUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.blockedUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Cancelled", currentReport.cancelledUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.cancelledUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Deferred", currentReport.deferredUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.deferredUserStories || 0) / currentReport.totalUserStories) * 100) : 0],
                ["Not Testable", currentReport.notTestableUserStories || 0, currentReport.totalUserStories ? Math.round(((currentReport.notTestableUserStories || 0) / currentReport.totalUserStories) * 100) : 0]
            ];
            const wsUserStories = XLSX.utils.aoa_to_sheet(userStoriesData);
            XLSX.utils.book_append_sheet(workbook, wsUserStories, "User Stories");

            // Test Cases Sheet
            const testCasesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.passedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.passedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Passed with Issues", currentReport.passedWithIssuesTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.passedWithIssuesTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Failed", currentReport.failedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.failedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Blocked", currentReport.blockedTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.blockedTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Cancelled", currentReport.cancelledTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.cancelledTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Deferred", currentReport.deferredTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.deferredTestCases || 0) / currentReport.totalTestCases) * 100) : 0],
                ["Not Testable", currentReport.notTestableTestCases || 0, currentReport.totalTestCases ? Math.round(((currentReport.notTestableTestCases || 0) / currentReport.totalTestCases) * 100) : 0]
            ];
            const wsTestCases = XLSX.utils.aoa_to_sheet(testCasesData);
            XLSX.utils.book_append_sheet(workbook, wsTestCases, "Test Cases");

            // Issues Sheet
            const issuesData = [
                ["Priority/Status", "Count", "Percentage"],
                ["", "", ""],
                ["PRIORITY BREAKDOWN", "", ""],
                ["Critical", currentReport.criticalIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.criticalIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["High", currentReport.highIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.highIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Medium", currentReport.mediumIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.mediumIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Low", currentReport.lowIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.lowIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["", "", ""],
                ["STATUS BREAKDOWN", "", ""],
                ["New", currentReport.newIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.newIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Fixed", currentReport.fixedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.fixedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Not Fixed", currentReport.notFixedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.notFixedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Re-opened", currentReport.reopenedIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.reopenedIssues || 0) / currentReport.totalIssues) * 100) : 0],
                ["Deferred", currentReport.deferredIssues || 0, currentReport.totalIssues ? Math.round(((currentReport.deferredIssues || 0) / currentReport.totalIssues) * 100) : 0]
            ];
            const wsIssues = XLSX.utils.aoa_to_sheet(issuesData);
            XLSX.utils.book_append_sheet(workbook, wsIssues, "Issues");

            // Enhancements Sheet
            const enhancementsData = [
                ["Status", "Count", "Percentage"],
                ["New", currentReport.newEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.newEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0],
                ["Implemented", currentReport.implementedEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.implementedEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0],
                ["Exists", currentReport.existsEnhancements || 0, currentReport.totalEnhancements ? Math.round(((currentReport.existsEnhancements || 0) / currentReport.totalEnhancements) * 100) : 0]
            ];
            const wsEnhancements = XLSX.utils.aoa_to_sheet(enhancementsData);
            XLSX.utils.book_append_sheet(workbook, wsEnhancements, "Enhancements");

            // Automation Regression Sheets
            const automationTestCasesData = [
                ["Status", "Count", "Percentage"],
                ["Passed", currentReport.automationPassedTestCases || 0, currentReport.automationPassedPercentage || 0],
                ["Failed", currentReport.automationFailedTestCases || 0, currentReport.automationFailedPercentage || 0],
                ["Skipped", currentReport.automationSkippedTestCases || 0, currentReport.automationSkippedPercentage || 0]
            ];
            const wsAutomationTestCases = XLSX.utils.aoa_to_sheet(automationTestCasesData);
            XLSX.utils.book_append_sheet(workbook, wsAutomationTestCases, "Automation Test Cases");

            const automationStabilityData = [
                ["Stability", "Count", "Percentage"],
                ["Stable", currentReport.automationStableTests || 0, currentReport.automationStablePercentage || 0],
                ["Flaky", currentReport.automationFlakyTests || 0, currentReport.automationFlakyPercentage || 0]
            ];
            const wsAutomationStability = XLSX.utils.aoa_to_sheet(automationStabilityData);
            XLSX.utils.book_append_sheet(workbook, wsAutomationStability, "Automation Stability");

            // Add all the additional sheets like in the main function - REMOVED evaluation
            // if (currentReport.evaluationData && Object.keys(currentReport.evaluationData).length > 0) {
            //     const evaluationHeaders = ["Evaluation Criteria", "Score", "Weight", "Weighted Score"];
            //     const evaluationSheetData = [];
            //     
            //     for (const [key, value] of Object.entries(currentReport.evaluationData)) {
            //         if (key.includes('_score')) {
            //             const criteriaName = key.replace('_score', '').replace(/_/g, ' ').toUpperCase();
            //             const weightKey = key.replace('_score', '_weight');
            //             const weight = currentReport.evaluationData[weightKey] || 1;
            //             const weightedScore = (value || 0) * weight;
            //             evaluationSheetData.push([criteriaName, value || 0, weight, weightedScore]);
            //         }
            //     }
            //     
            //     if (evaluationSheetData.length > 0) {
            //         evaluationSheetData.unshift(["", "", "", ""]);
            //         evaluationSheetData.unshift(["TOTAL EVALUATION SCORE", "", "", currentReport.evaluationTotalScore || 0]);
            //         const wsEvaluation = XLSX.utils.aoa_to_sheet([evaluationHeaders, ...evaluationSheetData]);
            //         XLSX.utils.book_append_sheet(workbook, wsEvaluation, "Evaluation");
            //     }
            // }

            // Dynamic Data Sheets
            if (currentReport.requestData && currentReport.requestData.length > 0) {
                const requestHeaders = ["Request ID", "URL"];
                const requestsSheetData = currentReport.requestData.map(req => [req.id, req.url]);
                const wsRequests = XLSX.utils.aoa_to_sheet([requestHeaders, ...requestsSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsRequests, "Requests");
            }

            if (currentReport.buildData && currentReport.buildData.length > 0) {
                const buildHeaders = ["Request ID", "URL", "Environment", "Cycles"];
                const buildsSheetData = currentReport.buildData.map(build => [build.requestId, build.requestUrl, build.environment, build.cycles]);
                const wsBuilds = XLSX.utils.aoa_to_sheet([buildHeaders, ...buildsSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsBuilds, "Builds");
            }

            if (currentReport.testerData && currentReport.testerData.length > 0) {
                const testerHeaders = ["Tester Name", "Email", "Roles"];
                const testersSheetData = currentReport.testerData.map(tester => {
                    const roles = [];
                    if (tester.is_automation_engineer) roles.push('Automation Engineer');
                    if (tester.is_manual_engineer) roles.push('Manual Engineer');
                    const roleText = roles.length > 0 ? roles.join(', ') : 'No roles assigned';
                    return [tester.name, tester.email || '', roleText];
                });
                const wsTesters = XLSX.utils.aoa_to_sheet([testerHeaders, ...testersSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsTesters, "Testers");
            }

            if (currentReport.teamMemberData && currentReport.teamMemberData.length > 0) {
                const teamHeaders = ["Team Member Name", "Email", "Role"];
                const teamSheetData = currentReport.teamMemberData.map(member => [member.name, member.email || '', member.role || '']);
                const wsTeam = XLSX.utils.aoa_to_sheet([teamHeaders, ...teamSheetData]);
                XLSX.utils.book_append_sheet(workbook, wsTeam, "Team Members");
            }

            // Custom Fields - REMOVED
            // if (currentReport.customFields && Object.keys(currentReport.customFields).length > 0) {
            //     const customFieldsHeaders = ["Field Name", "Value"];
            //     const customFieldsSheetData = Object.entries(currentReport.customFields).map(([key, value]) => [key, value]);
            //     const wsCustomFields = XLSX.utils.aoa_to_sheet([customFieldsHeaders, ...customFieldsSheetData]);
            //     XLSX.utils.book_append_sheet(workbook, wsCustomFields, "Custom Fields");
            // }

            XLSX.writeFile(workbook, `QA_Report_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}_Complete.xlsx`);
            showSuccessToast('Excel export completed successfully!');
        }

        async function exportStyledReportAsPdf() {
            if (!currentReport) {
                showErrorToast('Report data not loaded yet.');
                return;
            }

            showInfoToast('Generating styled PDF export...');

            const { jsPDF } = window.jspdf;
            const reportContent = document.querySelector('#reportContent');
            const sections = Array.from(reportContent.querySelectorAll('.dashboard-section'));

            if (!sections.length) {
                showErrorToast('Report content not found.');
                return;
            }

            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            let yPosition = 15;

            // Correctly detect theme based on the 'data-theme' attribute
            const isLightMode = document.documentElement.getAttribute('data-theme') === 'light';
            
            // Use EXACT colors from the CSS light theme variables to match view report
            const themeColors = {
                background: isLightMode ? '#ffffff' : '#0f172a',
                surface: isLightMode ? '#f8fafc' : '#1e293b',
                textPrimary: isLightMode ? '#1e293b' : '#f1f5f9',
                textSecondary: isLightMode ? '#64748b' : '#94a3b8',
                border: isLightMode ? '#e2e8f0' : '#334155',
                primary: '#3b82f6'
            };
            
            const themeBackgroundColor = themeColors.background;
            const textColor = themeColors.textPrimary;
            
            console.log('Light mode detected:', isLightMode);
            console.log('Using background color:', themeBackgroundColor);

            const addPageBackground = () => {
                pdf.setFillColor(themeBackgroundColor);
                pdf.rect(0, 0, pdfWidth, pdfHeight, 'F');
            };

            addPageBackground();

            pdf.setTextColor(textColor);
            pdf.setFontSize(18);
            pdf.text(document.getElementById('reportTitle').innerText, pdfWidth / 2, yPosition, { align: 'center' });
            yPosition += 8;
            pdf.setFontSize(10);
            pdf.text(document.getElementById('reportSubtitle').innerText, pdfWidth / 2, yPosition, { align: 'center' });
            yPosition += 12;

            for (const section of sections) {
                try {
                    const canvas = await html2canvas(section, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: themeBackgroundColor
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pdfWidth - 20;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (yPosition + imgHeight > pdfHeight - 15) {
                        pdf.addPage();
                        addPageBackground();
                        yPosition = 15;
                    }

                    pdf.addImage(imgData, 'PNG', 10, yPosition, imgWidth, imgHeight, null, 'FAST');
                    yPosition += imgHeight + 5;

                } catch (error) {
                    console.error('Could not render section to PDF:', error, section);
                }
            }

            pdf.save(`QA_Report_${currentReport.portfolioName}_Sprint_${currentReport.sprintNumber}_Styled.pdf`);
            showSuccessToast('Styled PDF export completed successfully!');
        }

        // Custom Message Box (instead of alert)
        function showCustomMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--surface);
                color: var(--text-primary);
                padding: 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-heavy);
                z-index: 9999;
                text-align: center;
                max-width: 300px;
                border: 1px solid var(--border);
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button onclick="this.parentNode.remove()" style="
                    background: var(--primary);
                    color: var(--text-primary);
                    border: none;
                    padding: 8px 15px;
                    border-radius: var(--border-radius);
                    cursor: pointer;
                    margin-top: 10px;
                ">OK</button>
            `;
            document.body.appendChild(messageBox);
        }

        // Authentication functions
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/profile');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userDisplayName').textContent = user.first_name;
                    
                    // Show admin links if user is admin
                    if (user.role === 'admin') {
                        document.getElementById('adminLinks').style.display = 'block';
                    }
                } else {
                    // User not authenticated, redirect to login
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
                window.location.href = '/login';
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        function toggleMobileMenu() {
            const navMenu = document.querySelector('.nav-menu');
            navMenu.classList.toggle('mobile-active');
        }
    </script>
    </div>

</body>
</html>
